# 批量付款管理页面结构分析

## 一、页面整体架构

### 1.1 技术栈
- **框架**: Vue 3 (Composition API + `<script setup>`)
- **语言**: TypeScript (严格模式)
- **UI库**: 
  - 主要：`@inno/inno-mc-vue3` (企业内部组件库)
  - 辅助：Element Plus
- **状态管理**: CRUD 模式 (基于 inno-mc-vue3)
- **路由**: Vue Router 4.x

### 1.2 页面层级结构
```
批量付款管理页面 (index.vue)
├── 页面头部 (app-page-header)
│   ├── 面包屑导航
│   └── CRUD操作按钮组
├── 页面主体 (app-page-body)
│   ├── 高级查询区域 (inno-query-operation)
│   └── 分割面板布局 (inno-split-pane)
│       ├── 上半部分 (50%高度，可调整)
│       │   ├── 左侧面板 (50%宽度，可调整)
│       │   │   ├── 状态Tab标签页
│       │   │   ├── 批量付款单列表表格
│       │   │   └── 分页组件
│       │   └── 右侧面板 (50%宽度，可调整)
│       │       └── 供应商信息表格
│       └── 下半部分 (50%高度，可调整)
│           └── 付款明细表格
└── 对话框组件 (PaymentAutoDialog.vue)
    ├── 表单区域
    │   ├── 公司选择
    │   ├── 核算部门级联选择
    │   └── 备注输入
    ├── 应付单查询区域
    └── 应付明细选择表格
```

## 二、核心布局实现

### 2.1 分割面板布局 (Split Pane)
使用 `inno-split-pane` 组件实现可调整的三区域布局：

```vue
<!-- 外层：上下分割 (horizontal) -->
<inno-split-pane split="horizontal" :default-percent="50" :min-percent="30">
  <!-- 上半部分 -->
  <template #paneL>
    <!-- 内层：左右分割 (vertical) -->
    <inno-split-pane split="vertical" :default-percent="50" :min-percent="30">
      <!-- 左侧：批量付款单列表 -->
      <template #paneL>...</template>
      <!-- 右侧：供应商信息 -->
      <template #paneR>...</template>
    </inno-split-pane>
  </template>
  
  <!-- 下半部分：付款明细 -->
  <template #paneR>...</template>
</inno-split-pane>
```

**关键参数**：
- `split`: 分割方向 (`horizontal` 上下分割 | `vertical` 左右分割)
- `default-percent`: 默认分割比例 (50 表示 50%)
- `min-percent`: 最小分割比例 (30 表示最小 30%)

### 2.2 三区域功能定位

#### 区域1：批量付款单列表 (左上)
- **位置**: 上半部分左侧，占 50% 宽度
- **功能**: 
  - 显示批量付款单主表数据
  - 支持多选、排序、分页
  - 状态Tab切换 (待提交/审批中/已完成/已驳回/全部)
  - 行点击触发联动
- **关键特性**:
  - `highlight-current-row`: 高亮当前选中行
  - `@row-click`: 行点击事件，触发右侧和下方数据加载

#### 区域2：供应商信息表格 (右上)
- **位置**: 上半部分右侧，占 50% 宽度
- **功能**: 
  - 显示选中批量付款单的供应商信息
  - 包含供应商名称、付款金额、收款账户
- **联动逻辑**: 
  - 监听左侧表格的 `currentPaymentId`
  - 自动调用 `loadAgentList(paymentAutoItemId)` 加载数据
  - 空状态提示: "请先选择批量付款单"

#### 区域3：付款明细表格 (下方)
- **位置**: 下半部分，占 50% 高度
- **功能**: 
  - 显示选中批量付款单的付款明细
  - 包含应付单号、供应商、账期类型、金额等
- **联动逻辑**: 
  - 监听左侧表格的 `currentPaymentId`
  - 自动调用 `loadDetailList(paymentAutoItemId)` 加载数据
  - 空状态提示: "请先选择批量付款单"

## 三、数据流与状态管理

### 3.1 CRUD 配置模式
使用 `@inno/inno-mc-vue3` 的 CRUD 模式管理列表数据：

```typescript
const crud1 = CRUD({
  title: '批量付款单',
  url: '/api/paymentAuto/page',
  idField: 'id',
  query: { status: '0' },
  method: 'get',
  crudMethod: {
    del: (ids) => paymentAutoApi.delete(ids)
  },
  hooks: {
    [CRUD.HOOK.afterToAdd]: (_crud: any) => {
      // 打开新增对话框
    },
    [CRUD.HOOK.afterToEdit]: (_crud: any) => {
      // 打开编辑对话框（_crud.form 为当前行数据）
    }
  },
  pageConfig: {
    pageIndex: 'page',
    pageSize: 'limit'
  }
}, { table: tableRef })
```

### 3.2 主从联动实现

```typescript
// 当前选中的批量付款单ID
const currentPaymentId = ref<string>('')

// 行点击事件处理
const handleRowClick = (row: PaymentAutoItem) => {
  currentPaymentId.value = row.id
  loadAgentList(row.id)      // 加载供应商信息
  loadDetailList(row.id)     // 加载付款明细
}

// 供应商信息列表
const agentList = ref<PaymentAutoAgent[]>([])
const agentLoading = ref(false)

// 付款明细列表
const detailList = ref<DebtDetail[]>([])
const detailLoading = ref(false)
```

### 3.3 状态Tab统计
```typescript
const statusTabCount = reactive<StatusTabCount>({
  waitSubmitCount: 0,    // 待提交
  holdingCount: 0,       // 审批中
  finishedCount: 0,      // 已完成
  rejectedCount: 0,      // 已驳回
  allCount: 0            // 全部
})

// Tab切换时重新加载统计
const tabActiveClick = (tab: TabsPaneContext) => {
  crud1.toQuery()
  loadStatusCount()
}
```

## 四、对话框组件 (PaymentAutoDialog.vue)

### 4.1 对话框触发方式
 
**新增对话框触发**：
```typescript
// 在主页面 index.vue 中
const dialogVisible = ref(false)
const dialogIsEdit = ref(false)
const dialogData = ref<PaymentAutoItem | null>(null)
 
// 重要：参考项目中 inno-mc-vue3 的 CRUD 组件，新增/编辑的触发应使用 hooks
// 否则可能出现点击“新增/编辑”但不触发弹窗的问题
hooks: {
  [CRUD.HOOK.afterToAdd]: (_crud: any) => {
    dialogData.value = null
    dialogIsEdit.value = false
    dialogVisible.value = true  // 打开对话框
  },
  [CRUD.HOOK.afterToEdit]: (_crud: any) => {
    dialogData.value = _crud.form
    dialogIsEdit.value = true
    dialogVisible.value = true  // 打开对话框
  }
}
```
 
**对话框组件使用**：
```vue
<PaymentAutoDialog 
  v-model:visible="dialogVisible" 
  :is-edit="dialogIsEdit" 
  :data="dialogData"
  @success="handleDialogSuccess" 
/>
```

### 4.2 对话框完整结构
```
对话框 (90% 宽度)
├── 标题栏
│   └── 新增批量付款单 / 编辑批量付款单
├── 基本信息表单区域
│   ├── 公司下拉选择 (el-select, 必填)
│   ├── 核算部门级联选择 (el-cascader, 必填)
│   └── 备注输入 (el-input, 可选)
├── 分割线 (el-divider)
├── 应付单查询表单区域 (多行布局)
│   ├── 第一行
│   │   ├── 核算部门 (禁用显示)
│   │   ├── 公司 (禁用显示)
│   │   ├── 客户 (可输入)
│   │   └── 供应商 (下拉选择)
│   ├── 第二行
│   │   ├── 应付单号 (可输入)
│   │   ├── 业务单元 (可输入)
│   │   ├── 项目名称 (可输入)
│   │   └── 币种 (下拉选择)
│   └── 第三行
│       ├── 采购合同号 (可输入)
│       └── 查询/清空按钮
├── 单据类型Tab标签页
│   ├── 预付账期
│   ├── 入库账期
│   ├── 销售账期
│   ├── 回款账期
│   ├── 验收账期
│   └── 质保账期
├── 应付明细选择表格 (max-height: 350px)
│   ├── 选择列 (checkbox)
│   ├── 序号列
│   ├── 应付单号
│   ├── 供应商
│   ├── 业务单元
│   ├── 客户
│   ├── 币种
│   ├── 预计付款日期
│   ├── 付款条件
│   ├── 付款金额
│   ├── 已付金额
│   ├── 剩余金额
│   ├── 采购合同号
│   ├── 项目名称
│   └── 本次付款金额 (el-input-number, 固定右侧)
├── 分页组件
│   └── 总数/每页条数/页码跳转
├── 汇总信息面板 (浅灰色背景)
│   ├── 明细数量 (蓝色)
│   ├── 供应商数量 (蓝色)
│   └── 总金额 (红色加粗)
└── 底部按钮
    ├── 取消按钮
    └── 保存按钮 (带 loading 状态)
```

### 4.3 单据类型Tab切换

**6种账期类型**：
```typescript
const activeDocumentType = ref('prepayment')

// Tab定义
<el-tabs v-model="activeDocumentType" @tab-click="handleDocumentTypeChange">
  <el-tab-pane label="预付账期" name="prepayment" />
  <el-tab-pane label="入库账期" name="warehousing" />
  <el-tab-pane label="销售账期" name="sales" />
  <el-tab-pane label="回款账期" name="collection" />
  <el-tab-pane label="验收账期" name="acceptance" />
  <el-tab-pane label="质保账期" name="warranty" />
</el-tabs>

// Tab切换处理
const handleDocumentTypeChange = () => {
  pagination.page = 1  // 重置到第一页
  loadDebtDetailList()  // 重新加载数据
}
```

### 4.4 查询表单功能

**查询字段说明**：
```typescript
const debtQuery = reactive({
  code: '',              // 应付单号
  agentId: '',          // 供应商ID
  departmentName: '',   // 核算部门（禁用，自动填充）
  companyName: '',      // 公司（禁用，自动填充）
  customer: '',         // 客户
  businessUnit: '',     // 业务单元
  projectName: '',      // 项目名称
  currency: '',         // 币种（CNY/USD/EUR）
  purchaseContractNo: '' // 采购合同号
})
```

**查询逻辑**：
```typescript
const loadDebtDetailList = async () => {
  if (!formData.companyId || !formData.departmentIdPath) {
    ElMessage.warning('请先选择公司和核算部门')
    return
  }

  const res = await debtApi.getDetailList({
    companyId: formData.companyId,
    departmentIdPath: formData.departmentIdPath,
    documentType: activeDocumentType.value,  // 单据类型
    ...debtQuery,  // 所有查询条件
    page: pagination.page,
    limit: pagination.limit
  })
}
```

### 4.5 分页功能

```typescript
const pagination = reactive({
  page: 1,
  limit: 20,
  total: 0
})

// 每页条数变更
const handleSizeChange = (size: number) => {
  pagination.limit = size
  pagination.page = 1
  loadDebtDetailList()
}

// 页码变更
const handleCurrentChange = (page: number) => {
  pagination.page = page
  loadDebtDetailList()
}
```

### 4.6 级联选择逻辑

```typescript
// 公司变更时
const handleCompanyChange = (companyId: string) => {
  const company = companyList.value.find(c => c.id === companyId)
  formData.companyName = company?.name
  debtQuery.companyName = company?.name  // 同步到查询条件
  // 清空应付明细列表
  debtDetailList.value = []
  selectedDebtDetails.value = []
}

// 部门变更时
const handleDepartmentChange = (value: string[]) => {
  formData.departmentCurrentId = value[value.length - 1]
  const dept = findDepartment(departmentTree.value, value)
  formData.departmentNamePath = dept?.namePath
  debtQuery.departmentName = dept?.namePath  // 同步到查询条件
  // 清空应付明细列表
  debtDetailList.value = []
}
```

### 4.7 实时汇总计算

```typescript
// 供应商数量（去重）
const supplierCount = computed(() => {
  const agentIds = new Set(selectedDebtDetails.value.map(d => d.agentName))
  return agentIds.size
})

// 总金额
const totalAmount = computed(() => {
  return selectedDebtDetails.value.reduce((sum, detail) => {
    return sum + (detail.currentPaymentAmount || 0)
  }, 0)
})
```

### 4.4 数据验证规则

```typescript
// 表单验证
const rules: FormRules = {
  companyId: [{ required: true, message: '请选择公司', trigger: 'change' }],
  departmentIdPath: [{ required: true, message: '请选择核算部门', trigger: 'change' }]
}

// 提交前业务验证
if (selectedDebtDetails.value.length === 0) {
  ElMessage.warning('请至少选择一条应付明细')
  return
}

const hasInvalidAmount = selectedDebtDetails.value.some(
  detail => !detail.currentPaymentAmount || detail.currentPaymentAmount <= 0
)
if (hasInvalidAmount) {
  ElMessage.warning('请为所有选中的明细填写本次付款金额')
  return
}

const hasExceedAmount = selectedDebtDetails.value.some(
  detail => detail.currentPaymentAmount! > detail.remainingAmount
)
if (hasExceedAmount) {
  ElMessage.warning('本次付款金额不能超过剩余金额')
  return
}
```

## 五、TypeScript 类型定义

### 5.1 核心实体接口

```typescript
// 批量付款单
interface PaymentAutoItem {
  id: string
  code: string                    // 批量付款单号
  billDate: string                // 单据日期
  companyId: string
  companyName: string
  companyCode: string
  departmentIdPath: string        // 部门ID路径
  departmentNamePath: string      // 部门名称路径
  departmentCurrentId: string     // 当前部门ID
  status: PaymentAutoStatus       // 状态枚举
  statusDescription?: string      // 状态描述
  totalAmount: number             // 总金额
  remark?: string
  createdBy: string
  createdAt: string
}

// 批量付款供应商
interface PaymentAutoAgent {
  id: string
  paymentAutoItemId: string
  agentId: string
  agentName: string               // 供应商名称
  accountName: string             // 银行账户名称
  accountNo: string               // 银行账号
  bankName: string                // 开户行名称
  bankCode: string                // 开户行编码
  sum?: number                    // 付款金额汇总
  accountInfo?: string            // 收款账户完整信息
}

// 应付明细
interface DebtDetail {
  id: string
  debtId: string
  sequenceNo: number
  paymentTermType: string         // 账期类型
  expectedPaymentDate: string     // 预计付款日期
  paymentAmount: number           // 应付金额
  paidAmount: number              // 已付金额
  remainingAmount: number         // 剩余金额
  debtCode?: string               // 应付单号
  agentName?: string              // 供应商名称
  documentType?: string           // 应付单据类型
  currentPaymentAmount?: number   // 本次付款金额（用于对话框）
}

// 状态枚举
enum PaymentAutoStatus {
  WaitSubmit = 0,    // 待提交
  Holding = 1,       // 审批中
  Finished = 2,      // 已完成
  Rejected = 11      // 已驳回
}
```

## 六、样式与格式化

### 6.1 金额格式化
```typescript
const formatAmount = (amount: number | undefined | null): string => {
  if (amount === undefined || amount === null) return '0.00'
  return amount.toLocaleString('zh-CN', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  })
}
```

**显示效果**: `50,000.00` (千分位分隔 + 两位小数)

### 6.2 日期格式化
```typescript
import { dateFormat } from '@inno/inno-mc-vue3/lib/utils/filters'

// 模板中使用
{{ dateFormat(scope.row.billDate, 'YYYY-MM-DD') }}
```

**显示效果**: `2025-12-15`

### 6.3 表格样式配置
```typescript
// 表头样式
:header-cell-style="{ background: '#EBEEF5', color: '#909399' }"

// 金额列右对齐
<el-table-column align="right" />

// 边框和斑马纹
<el-table border stripe />

// 小尺寸表格（供应商和明细）
<el-table size="small" />
```

## 七、API 接口设计

### 7.1 批量付款单接口
```typescript
// 分页查询
GET /api/paymentAuto/page
  ?page=1&limit=20&status=0&code=xxx

// 状态统计
GET /api/paymentAuto/statusCount

// 获取供应商信息
GET /api/paymentAuto/{id}/agents

// 获取付款明细
GET /api/paymentAuto/{id}/details

// 创建
POST /api/paymentAuto

// 更新
PUT /api/paymentAuto/{id}

// 删除
DELETE /api/paymentAuto/{ids}
```

### 7.2 应付单接口
```typescript
// 查询应付明细列表（用于对话框选择）
GET /api/debt/details
  ?companyId=xxx&departmentIdPath=xxx&code=xxx&agentId=xxx
```

## 八、关键交互流程

### 8.1 新增批量付款单流程
1. 点击"新增"按钮 → 打开对话框
2. 选择公司和核算部门
3. 点击"查询"按钮 → 加载应付明细列表
4. 勾选应付明细，填写本次付款金额
5. 实时显示汇总信息（明细数量、供应商数量、总金额）
6. 点击"保存" → 验证数据 → 提交到后端
7. 成功后关闭对话框，刷新主列表

### 8.2 编辑批量付款单流程
1. 选中待提交状态的记录，点击"编辑"
2. 对话框回显数据（公司、部门、已选明细）
3. 修改数据（可重新选择明细）
4. 点击"保存" → 更新数据
5. 成功后刷新列表

### 8.3 主从联动流程
1. 点击批量付款单列表中的某一行
2. 高亮当前行，记录 `currentPaymentId`
3. 并行加载：
   - 右侧供应商信息表格
   - 下方付款明细表格
4. 显示 loading 状态
5. 数据加载完成后渲染表格

## 九、权限控制

### 9.1 操作权限配置
```typescript
const crudPermission = ref({
  add: ['/paymentAuto/All'],
  edit: ['/paymentAuto/All'],
  del: ['/paymentAuto/All'],
  download: ['/paymentAuto/All']
})
```

### 9.2 状态权限规则
| 操作 | 待提交(0) | 审批中(1) | 已完成(2) | 已驳回(11) |
|------|-----------|-----------|-----------|------------|
| 查看 | ✅ | ✅ | ✅ | ✅ |
| 编辑 | ✅ | ❌ | ❌ | ✅ |
| 删除 | ✅ | ❌ | ❌ | ❌ |
| 提交 | ✅ | ❌ | ❌ | ✅ |

## 十、性能优化建议

1. **虚拟滚动**: 大数据量表格使用虚拟滚动组件
2. **防抖查询**: 输入框查询添加 300ms 防抖
3. **分页加载**: 避免一次性加载所有数据
4. **计算属性缓存**: 利用 Vue 的计算属性缓存机制
5. **组件懒加载**: 对话框组件使用动态导入
6. **并行请求**: 供应商和明细数据并行加载

## 十一、文件清单

### 11.1 页面组件
- `src/views/paymentAuto/index.vue` - 主页面
- `src/views/paymentAuto/components/PaymentAutoDialog.vue` - 新增/编辑对话框

### 11.2 API 服务
- `src/api/paymentAuto.ts` - API 接口封装

### 11.3 类型定义
- `src/types/paymentAuto.ts` - TypeScript 类型定义

### 11.4 路由配置
- `src/router/index.ts` - 路由注册