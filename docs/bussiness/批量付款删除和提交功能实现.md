# 批量付款删除和提交功能实现

## 实现时间
2025年12月15日 15:35

## 功能概述

根据UI界面需求，实现批量付款单的**删除**和**提交**功能。

## 功能说明

### 1. 删除功能

**业务规则**：
- 只有**待提交**状态的批量付款单才能删除
- 删除采用**软删除**方式，标记 `IsDeleted = true`
- 删除批量付款单时，同时软删除所有关联的明细和供应商信息
- 删除后不可恢复

**API 端点**：
```
DELETE /api/payment-auto/{id}
```

**请求参数**：
- `id`: 批量付款单ID (Guid)

**响应示例**：
```json
{
  "success": true,
  "message": "批量付款单删除成功"
}
```

**错误响应**：
```json
{
  "success": false,
  "message": "只有待提交状态才能删除"
}
```

### 2. 提交功能

**业务规则**：
- 只有**待提交**状态的批量付款单才能提交
- 提交前必须包含至少一条明细
- 提交前必须包含至少一个供应商
- 提交后状态变更为**审批中**
- 提交后不可修改或删除

**API 端点**：
```
POST /api/payment-auto/{id}/submit
```

**请求参数**：
- `id`: 批量付款单ID (Guid)

**响应示例**：
```json
{
  "success": true,
  "data": true,
  "message": "批量付款单提交成功"
}
```

**错误响应**：
```json
{
  "success": false,
  "message": "批量付款单必须包含至少一条明细"
}
```

## 技术实现

### 1. 领域层 (Domain Layer)

**文件**: `PaymentAutoItem.cs`

#### 删除方法

```csharp
/// <summary>
/// 标记为删除
/// </summary>
public void MarkAsDeleted()
{
    if (Status != PaymentAutoStatus.Pending)
        throw new BusinessException("INVALID_STATUS", "只有待提交状态才能删除");

    IsDeleted = true;
    UpdatedAt = DateTime.UtcNow;

    // 级联删除所有明细
    foreach (var detail in _details.Where(d => !d.IsDeleted))
    {
        detail.MarkAsDeleted();
    }

    // 级联删除所有供应商
    foreach (var agent in _agents.Where(a => !a.IsDeleted))
    {
        agent.MarkAsDeleted();
    }

    AddDomainEvent(new PaymentAutoItemDeletedEvent(Id, Code));
}
```

**关键点**：
- 状态验证：只允许待提交状态删除
- 级联删除：自动删除所有关联的明细和供应商
- 领域事件：发布删除事件用于后续处理

#### 提交方法

```csharp
/// <summary>
/// 提交审批
/// </summary>
public void Submit()
{
    if (Status != PaymentAutoStatus.Pending)
        throw new BusinessException("INVALID_STATUS", "只有待提交状态才能提交审批");

    if (!_details.Any(d => !d.IsDeleted))
        throw new BusinessException("NO_DETAILS", "批量付款单必须包含至少一条明细");

    if (!_agents.Any(a => !a.IsDeleted))
        throw new BusinessException("NO_AGENTS", "批量付款单必须包含至少一个供应商");

    UpdateStatus(PaymentAutoStatus.Approving);
}
```

**关键点**：
- 状态验证：只允许待提交状态提交
- 数据验证：必须包含明细和供应商
- 状态流转：待提交 → 审批中

### 2. 应用层 (Application Layer)

**文件**: `IPaymentAutoApplicationService.cs`

```csharp
/// <summary>
/// 删除批量付款单
/// </summary>
Task<bool> DeleteAsync(Guid id, CancellationToken cancellationToken = default);

/// <summary>
/// 提交批量付款单
/// </summary>
Task<bool> SubmitAsync(Guid id, CancellationToken cancellationToken = default);
```

**文件**: `PaymentAutoApplicationService.cs`

#### 删除实现

```csharp
public async Task<bool> DeleteAsync(Guid id, CancellationToken cancellationToken = default)
{
    var item = await _paymentAutoItemRepository.GetByIdAsync(id, cancellationToken);
    if (item == null)
        return false;

    item.MarkAsDeleted();

    await _paymentAutoItemRepository.UpdateAsync(item, cancellationToken);
    await _unitOfWork.SaveChangesAsync(cancellationToken);

    return true;
}
```

#### 提交实现

```csharp
public async Task<bool> SubmitAsync(Guid id, CancellationToken cancellationToken = default)
{
    var item = await _paymentAutoItemRepository.GetByIdAsync(id, cancellationToken);
    if (item == null)
        throw new BusinessException("ITEM_NOT_FOUND", "批量付款单不存在");

    item.Submit();

    await _paymentAutoItemRepository.UpdateAsync(item, cancellationToken);
    await _unitOfWork.SaveChangesAsync(cancellationToken);

    return true;
}
```

**关键点**：
- 使用工作单元模式管理事务
- 调用领域模型的业务方法
- 统一的异常处理

### 3. 接口层 (API Layer)

**文件**: `PaymentAutoController.cs`

#### 删除端点

```csharp
/// <summary>
/// 删除批量付款单
/// </summary>
[HttpDelete("{id}")]
public async Task<IActionResult> Delete(Guid id, CancellationToken cancellationToken)
{
    try
    {
        var result = await _paymentAutoService.DeleteAsync(id, cancellationToken);
        if (!result)
        {
            return NotFound(new
            {
                success = false,
                message = "批量付款单不存在"
            });
        }

        return Ok(new
        {
            success = true,
            message = "批量付款单删除成功"
        });
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "删除批量付款单失败: {Id}", id);
        return BadRequest(new
        {
            success = false,
            message = ex.Message
        });
    }
}
```

#### 提交端点

```csharp
/// <summary>
/// 提交批量付款单
/// </summary>
[HttpPost("{id}/submit")]
public async Task<IActionResult> Submit(Guid id, CancellationToken cancellationToken)
{
    try
    {
        var result = await _paymentAutoService.SubmitAsync(id, cancellationToken);
        return Ok(new
        {
            success = true,
            data = result,
            message = "批量付款单提交成功"
        });
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "提交批量付款单失败: {Id}", id);
        return BadRequest(new
        {
            success = false,
            message = ex.Message
        });
    }
}
```

## 状态流转

### 批量付款单状态

```
待提交 (Pending = 0)
    ↓ Submit()
审批中 (Approving = 1)
    ↓ Approve()
已完成 (Completed = 2)

审批中 (Approving = 1)
    ↓ Reject()
已驳回 (Rejected = 11)
```

### 允许的操作

| 状态 | 删除 | 提交 | 修改 | 查看 |
|------|------|------|------|------|
| 待提交 | ✅ | ✅ | ✅ | ✅ |
| 审批中 | ❌ | ❌ | ❌ | ✅ |
| 已完成 | ❌ | ❌ | ❌ | ✅ |
| 已驳回 | ❌ | ❌ | ❌ | ✅ |

## 使用示例

### 删除批量付款单

```bash
# 请求
curl -X DELETE https://localhost:61801/api/payment-auto/{id}

# 成功响应
{
  "success": true,
  "message": "批量付款单删除成功"
}

# 失败响应（状态不允许）
{
  "success": false,
  "message": "只有待提交状态才能删除"
}
```

### 提交批量付款单

```bash
# 请求
curl -X POST https://localhost:61801/api/payment-auto/{id}/submit

# 成功响应
{
  "success": true,
  "data": true,
  "message": "批量付款单提交成功"
}

# 失败响应（缺少明细）
{
  "success": false,
  "message": "批量付款单必须包含至少一条明细"
}
```

## 测试场景

### 删除功能测试

1. **正常删除**
   - 创建待提交状态的批量付款单
   - 调用删除接口
   - 验证软删除标记已设置
   - 验证明细和供应商也被删除

2. **状态限制测试**
   - 创建并提交批量付款单（状态变为审批中）
   - 尝试删除
   - 验证返回错误信息

3. **不存在的单据**
   - 使用不存在的ID调用删除接口
   - 验证返回404错误

### 提交功能测试

1. **正常提交**
   - 创建批量付款单并添加明细和供应商
   - 调用提交接口
   - 验证状态变更为审批中
   - 验证领域事件已发布

2. **缺少明细**
   - 创建批量付款单但不添加明细
   - 尝试提交
   - 验证返回错误信息

3. **缺少供应商**
   - 创建批量付款单并添加明细但不添加供应商
   - 尝试提交
   - 验证返回错误信息

4. **重复提交**
   - 提交批量付款单
   - 再次尝试提交
   - 验证返回状态错误信息

## 错误处理

### 业务异常

| 错误码 | 错误信息 | 场景 |
|--------|---------|------|
| INVALID_STATUS | 只有待提交状态才能删除 | 删除非待提交状态的单据 |
| INVALID_STATUS | 只有待提交状态才能提交审批 | 提交非待提交状态的单据 |
| NO_DETAILS | 批量付款单必须包含至少一条明细 | 提交时缺少明细 |
| NO_AGENTS | 批量付款单必须包含至少一个供应商 | 提交时缺少供应商 |
| ITEM_NOT_FOUND | 批量付款单不存在 | 操作不存在的单据 |

### 日志记录

```csharp
_logger.LogError(ex, "删除批量付款单失败: {Id}", id);
_logger.LogError(ex, "提交批量付款单失败: {Id}", id);
```

## 后续扩展

### 已实现功能

- ✅ 删除批量付款单
- ✅ 提交批量付款单
- ✅ 状态验证
- ✅ 数据完整性验证
- ✅ 软删除机制

### 暂未实现功能

根据需求，以下功能暂不实现：

- ⏸️ 审批通过 (Approve)
- ⏸️ 审批驳回 (Reject)
- ⏸️ 撤回提交
- ⏸️ 批量删除
- ⏸️ 删除恢复
- ⏸️ 审批流程集成
- ⏸️ OA系统集成

## 相关文档

- [批量付款实现总结](./批量付款实现总结.md)
- [批量付款数据库设计](./11.批量付款数据库设计.md)
- [供应商和应付表实现总结](./供应商和应付表实现总结.md)
- [数据初始化优化总结](./数据初始化优化总结.md)

## 总结

✅ **已完成**：
- 实现批量付款单删除功能（软删除）
- 实现批量付款单提交功能（状态流转）
- 添加完整的业务规则验证
- 提供RESTful API接口
- 统一的错误处理和日志记录

✅ **编译状态**：
- Domain Layer: 编译成功
- Application Layer: 编译成功
- Infrastructure Layer: 编译成功
- Backend API: 编译成功

🎉 **批量付款的删除和提交功能已完整实现！**
