# æ‰¹é‡ä»˜æ¬¾å¢åŠ åŠŸèƒ½è¯´æ˜

## åŠŸèƒ½æ¦‚è¿°

"å¢åŠ "åŠŸèƒ½ç”¨äºåˆ›å»ºæ–°çš„æ‰¹é‡ä»˜æ¬¾å•ã€‚ç”¨æˆ·å¯ä»¥é€‰æ‹©åº”ä»˜æ˜ç»†ï¼Œç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆæ‰¹é‡ä»˜æ¬¾å•å¹¶å…³è”ä¾›åº”å•†ä¿¡æ¯ã€‚

## API ç«¯ç‚¹

### åˆ›å»ºæ‰¹é‡ä»˜æ¬¾å•

**è¯·æ±‚**ï¼š
```
POST /api/payment-auto
Content-Type: application/json
```

**è¯·æ±‚ä½“**ï¼š
```json
{
  "companyId": "11111111-1111-1111-1111-111111111111",
  "companyName": "æ€»éƒ¨å…¬å¸",
  "companyCode": "C001",
  "departmentIdPath": "01/0101",
  "departmentNamePath": "æ€»éƒ¨/è´¢åŠ¡éƒ¨",
  "departmentCurrentId": "0101",
  "remark": "2025å¹´1æœˆæ‰¹é‡ä»˜æ¬¾",
  "attachmentIds": null,
  "details": [
    {
      "debtDetailId": "åº”ä»˜æ˜ç»†ID1",
      "paymentAmount": 50000.00
    },
    {
      "debtDetailId": "åº”ä»˜æ˜ç»†ID2",
      "paymentAmount": 30000.00
    }
  ]
}
```

**å“åº”**ï¼š
```json
{
  "success": true,
  "data": {
    "id": "ç”Ÿæˆçš„æ‰¹é‡ä»˜æ¬¾å•ID",
    "code": "PAY202512150001",
    "billDate": "2025-12-15T07:31:02Z",
    "companyId": "11111111-1111-1111-1111-111111111111",
    "companyName": "æ€»éƒ¨å…¬å¸",
    "companyCode": "C001",
    "departmentIdPath": "01/0101",
    "departmentNamePath": "æ€»éƒ¨/è´¢åŠ¡éƒ¨",
    "departmentCurrentId": "0101",
    "status": 0,
    "statusDescription": "å¾…æäº¤",
    "totalAmount": 80000.00,
    "remark": "2025å¹´1æœˆæ‰¹é‡ä»˜æ¬¾",
    "details": [
      {
        "id": "æ˜ç»†ID1",
        "debtDetailId": "åº”ä»˜æ˜ç»†ID1",
        "paymentAmount": 50000.00
      },
      {
        "id": "æ˜ç»†ID2",
        "debtDetailId": "åº”ä»˜æ˜ç»†ID2",
        "paymentAmount": 30000.00
      }
    ],
    "agents": [
      {
        "id": "ä¾›åº”å•†å…³è”ID",
        "agentId": "ä¾›åº”å•†ID",
        "agentName": "ä¸Šæµ·XXè´¸æ˜“æœ‰é™å…¬å¸",
        "accountName": "ä¸Šæµ·XXè´¸æ˜“æœ‰é™å…¬å¸",
        "accountNo": "6222020202020202",
        "bankName": "ä¸­å›½å·¥å•†é“¶è¡Œä¸Šæµ·åˆ†è¡Œ",
        "bankCode": "ICBKSH01"
      }
    ],
    "createdAt": "2025-12-15T07:31:02Z"
  },
  "message": "æ‰¹é‡ä»˜æ¬¾å•åˆ›å»ºæˆåŠŸ"
}
```

## å­—æ®µè¯´æ˜

### å¿…å¡«å­—æ®µ

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|
| companyId | Guid | å…¬å¸ID | 11111111-1111-1111-1111-111111111111 |
| companyName | string | å…¬å¸åç§° | æ€»éƒ¨å…¬å¸ |
| companyCode | string | å…¬å¸ç¼–ç  | C001 |
| details | array | ä»˜æ¬¾æ˜ç»†åˆ—è¡¨ | è‡³å°‘åŒ…å«ä¸€æ¡æ˜ç»† |

### å¯é€‰å­—æ®µ

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|
| departmentIdPath | string | éƒ¨é—¨IDè·¯å¾„ | 01/0101 |
| departmentNamePath | string | éƒ¨é—¨åç§°è·¯å¾„ | æ€»éƒ¨/è´¢åŠ¡éƒ¨ |
| departmentCurrentId | string | å½“å‰éƒ¨é—¨ID | 0101 |
| remark | string | å¤‡æ³¨ | 2025å¹´1æœˆæ‰¹é‡ä»˜æ¬¾ |
| attachmentIds | string | é™„ä»¶IDåˆ—è¡¨ | null |

### æ˜ç»†å­—æ®µ

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|
| debtDetailId | Guid | åº”ä»˜æ˜ç»†ID | xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx |
| paymentAmount | decimal | ä»˜æ¬¾é‡‘é¢ | 50000.00 |

## ä¸šåŠ¡é€»è¾‘

### 1. å•å·ç”Ÿæˆ

ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆæ‰¹é‡ä»˜æ¬¾å•å·ï¼Œæ ¼å¼ï¼š`PAY{æ—¥æœŸyyyyMMdd}{åºå·4ä½}`

ç¤ºä¾‹ï¼š
- `PAY202512150001` - 2025å¹´12æœˆ15æ—¥ç¬¬1å•
- `PAY202512150002` - 2025å¹´12æœˆ15æ—¥ç¬¬2å•

### 2. ä¾›åº”å•†è‡ªåŠ¨å…³è”

ç³»ç»Ÿæ ¹æ®åº”ä»˜æ˜ç»†è‡ªåŠ¨å…³è”ä¾›åº”å•†ä¿¡æ¯ï¼š

1. è·å–æ‰€æœ‰åº”ä»˜æ˜ç»†å¯¹åº”çš„åº”ä»˜å•
2. æå–åº”ä»˜å•ä¸­çš„ä¾›åº”å•†IDï¼ˆå»é‡ï¼‰
3. æŸ¥è¯¢ä¾›åº”å•†çš„é“¶è¡Œè´¦å·ä¿¡æ¯
4. è‡ªåŠ¨æ·»åŠ åˆ°æ‰¹é‡ä»˜æ¬¾å•çš„ä¾›åº”å•†åˆ—è¡¨

**ç¤ºä¾‹æµç¨‹**ï¼š
```
åº”ä»˜æ˜ç»†1 â†’ åº”ä»˜å•A â†’ ä¾›åº”å•†1ï¼ˆä¸Šæµ·XXè´¸æ˜“ï¼‰
åº”ä»˜æ˜ç»†2 â†’ åº”ä»˜å•A â†’ ä¾›åº”å•†1ï¼ˆä¸Šæµ·XXè´¸æ˜“ï¼‰
åº”ä»˜æ˜ç»†3 â†’ åº”ä»˜å•B â†’ ä¾›åº”å•†2ï¼ˆæ­å·YYæŠ€æœ¯ï¼‰

ç»“æœï¼šæ‰¹é‡ä»˜æ¬¾å•åŒ…å«2ä¸ªä¾›åº”å•†
```

### 3. çŠ¶æ€åˆå§‹åŒ–

æ–°åˆ›å»ºçš„æ‰¹é‡ä»˜æ¬¾å•çŠ¶æ€ä¸º**å¾…æäº¤** (Pending = 0)

### 4. é‡‘é¢è®¡ç®—

æ€»é‡‘é¢ = æ‰€æœ‰æ˜ç»†çš„ä»˜æ¬¾é‡‘é¢ä¹‹å’Œ

## éªŒè¯è§„åˆ™

### åˆ›å»ºå‰éªŒè¯

1. **å…¬å¸ä¿¡æ¯éªŒè¯**
   - å…¬å¸IDä¸èƒ½ä¸ºç©º
   - å…¬å¸åç§°ä¸èƒ½ä¸ºç©º
   - å…¬å¸ç¼–ç ä¸èƒ½ä¸ºç©º

2. **æ˜ç»†éªŒè¯**
   - è‡³å°‘åŒ…å«ä¸€æ¡æ˜ç»†
   - æ¯æ¡æ˜ç»†çš„åº”ä»˜æ˜ç»†IDå¿…é¡»å­˜åœ¨
   - æ¯æ¡æ˜ç»†çš„ä»˜æ¬¾é‡‘é¢å¿…é¡»å¤§äº0

3. **åº”ä»˜æ˜ç»†éªŒè¯**
   - åº”ä»˜æ˜ç»†å¿…é¡»å­˜åœ¨ä¸”æœªåˆ é™¤
   - åº”ä»˜æ˜ç»†çš„å‰©ä½™é‡‘é¢å¿…é¡»è¶³å¤Ÿ
   - ä¸èƒ½é‡å¤æ·»åŠ åŒä¸€ä¸ªåº”ä»˜æ˜ç»†

### åˆ›å»ºåéªŒè¯

ç³»ç»Ÿä¼šè‡ªåŠ¨éªŒè¯ï¼š
- æ‰¹é‡ä»˜æ¬¾å•å¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªä¾›åº”å•†
- ä¾›åº”å•†å¿…é¡»æœ‰å®Œæ•´çš„é“¶è¡Œè´¦å·ä¿¡æ¯

## ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šåˆ›å»ºå•ä¾›åº”å•†æ‰¹é‡ä»˜æ¬¾å•

```bash
curl -X POST https://localhost:61801/api/payment-auto \
  -H "Content-Type: application/json" \
  -d '{
    "companyId": "11111111-1111-1111-1111-111111111111",
    "companyName": "æ€»éƒ¨å…¬å¸",
    "companyCode": "C001",
    "departmentIdPath": "01/0101",
    "departmentNamePath": "æ€»éƒ¨/è´¢åŠ¡éƒ¨",
    "departmentCurrentId": "0101",
    "remark": "é‡‡è´­ä»˜æ¬¾",
    "details": [
      {
        "debtDetailId": "åº”ä»˜æ˜ç»†ID1",
        "paymentAmount": 50000.00
      },
      {
        "debtDetailId": "åº”ä»˜æ˜ç»†ID2",
        "paymentAmount": 30000.00
      }
    ]
  }'
```

### ç¤ºä¾‹2ï¼šåˆ›å»ºå¤šä¾›åº”å•†æ‰¹é‡ä»˜æ¬¾å•

```bash
curl -X POST https://localhost:61801/api/payment-auto \
  -H "Content-Type: application/json" \
  -d '{
    "companyId": "22222222-2222-2222-2222-222222222222",
    "companyName": "åä¸œåˆ†å…¬å¸",
    "companyCode": "C002",
    "departmentIdPath": "02/0203",
    "departmentNamePath": "åä¸œ/å…±äº«ä¸­å¿ƒ",
    "departmentCurrentId": "0203",
    "remark": "æœˆåº¦æ‰¹é‡ä»˜æ¬¾",
    "details": [
      {
        "debtDetailId": "ä¾›åº”å•†1çš„åº”ä»˜æ˜ç»†ID",
        "paymentAmount": 100000.00
      },
      {
        "debtDetailId": "ä¾›åº”å•†2çš„åº”ä»˜æ˜ç»†ID",
        "paymentAmount": 80000.00
      }
    ]
  }'
```

## é”™è¯¯å¤„ç†

### å¸¸è§é”™è¯¯

| é”™è¯¯ç  | é”™è¯¯ä¿¡æ¯ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|--------|---------|------|---------|
| INVALID_COMPANY | å…¬å¸ä¿¡æ¯ä¸å®Œæ•´ | ç¼ºå°‘å…¬å¸IDã€åç§°æˆ–ç¼–ç  | è¡¥å……å®Œæ•´çš„å…¬å¸ä¿¡æ¯ |
| NO_DETAILS | æ‰¹é‡ä»˜æ¬¾å•å¿…é¡»åŒ…å«è‡³å°‘ä¸€æ¡æ˜ç»† | detailsæ•°ç»„ä¸ºç©º | æ·»åŠ è‡³å°‘ä¸€æ¡æ˜ç»† |
| INVALID_AMOUNT | ä»˜æ¬¾é‡‘é¢å¿…é¡»å¤§äº0 | paymentAmount <= 0 | è®¾ç½®æ­£ç¡®çš„ä»˜æ¬¾é‡‘é¢ |
| DEBT_DETAIL_NOT_FOUND | åº”ä»˜æ˜ç»†ä¸å­˜åœ¨ | debtDetailIdæ— æ•ˆ | ä½¿ç”¨æœ‰æ•ˆçš„åº”ä»˜æ˜ç»†ID |
| DUPLICATE_DEBT_DETAIL | è¯¥åº”ä»˜æ˜ç»†å·²å­˜åœ¨ | é‡å¤æ·»åŠ åŒä¸€æ˜ç»† | ç§»é™¤é‡å¤çš„æ˜ç»† |
| NO_AGENTS | æ‰¹é‡ä»˜æ¬¾å•å¿…é¡»åŒ…å«è‡³å°‘ä¸€ä¸ªä¾›åº”å•† | åº”ä»˜æ˜ç»†æ²¡æœ‰å…³è”ä¾›åº”å•† | æ£€æŸ¥åº”ä»˜æ˜ç»†æ•°æ® |

### é”™è¯¯å“åº”ç¤ºä¾‹

```json
{
  "success": false,
  "message": "æ‰¹é‡ä»˜æ¬¾å•å¿…é¡»åŒ…å«è‡³å°‘ä¸€æ¡æ˜ç»†"
}
```

## å‰ç«¯é›†æˆå»ºè®®

### 1. é€‰æ‹©åº”ä»˜æ˜ç»†

å‰ç«¯åº”æä¾›åº”ä»˜æ˜ç»†é€‰æ‹©ç•Œé¢ï¼š
- æ˜¾ç¤ºåº”ä»˜æ˜ç»†åˆ—è¡¨ï¼ˆåº”ä»˜å•å·ã€ä¾›åº”å•†ã€é‡‘é¢ã€é¢„è®¡ä»˜æ¬¾æ—¥æœŸç­‰ï¼‰
- æ”¯æŒå¤šé€‰
- æ˜¾ç¤ºå‰©ä½™é‡‘é¢
- æ”¯æŒæŒ‰ä¾›åº”å•†ã€å…¬å¸ã€éƒ¨é—¨ç­›é€‰

### 2. å¡«å†™ä»˜æ¬¾ä¿¡æ¯

- è‡ªåŠ¨å¡«å……å…¬å¸ä¿¡æ¯ï¼ˆä»ç”¨æˆ·ä¸Šä¸‹æ–‡è·å–ï¼‰
- å¯é€‰å¡«å……éƒ¨é—¨ä¿¡æ¯
- è¾“å…¥å¤‡æ³¨
- ä¸Šä¼ é™„ä»¶ï¼ˆå¯é€‰ï¼‰

### 3. ç¡®è®¤åˆ›å»º

- æ˜¾ç¤ºé€‰ä¸­çš„åº”ä»˜æ˜ç»†æ±‡æ€»
- æ˜¾ç¤ºæ€»é‡‘é¢
- æ˜¾ç¤ºæ¶‰åŠçš„ä¾›åº”å•†åˆ—è¡¨
- ç¡®è®¤åè°ƒç”¨åˆ›å»ºAPI

### 4. åˆ›å»ºåæ“ä½œ

åˆ›å»ºæˆåŠŸåå¯ä»¥ï¼š
- è·³è½¬åˆ°è¯¦æƒ…é¡µæŸ¥çœ‹
- ç»§ç»­æ·»åŠ æ›´å¤šæ˜ç»†
- ç›´æ¥æäº¤å®¡æ‰¹

## å®Œæ•´æµç¨‹ç¤ºä¾‹

### æ­¥éª¤1ï¼šæŸ¥è¯¢å¯ç”¨çš„åº”ä»˜æ˜ç»†

```bash
# å‡è®¾æœ‰æŸ¥è¯¢åº”ä»˜æ˜ç»†çš„API
GET /api/debt-details?status=unpaid&companyId=xxx
```

### æ­¥éª¤2ï¼šåˆ›å»ºæ‰¹é‡ä»˜æ¬¾å•

```bash
POST /api/payment-auto
{
  "companyId": "11111111-1111-1111-1111-111111111111",
  "companyName": "æ€»éƒ¨å…¬å¸",
  "companyCode": "C001",
  "details": [...]
}
```

### æ­¥éª¤3ï¼šæŸ¥çœ‹åˆ›å»ºç»“æœ

```bash
GET /api/payment-auto/{id}
```

### æ­¥éª¤4ï¼šæäº¤å®¡æ‰¹

```bash
POST /api/payment-auto/{id}/submit
```

## æ€§èƒ½ä¼˜åŒ–

### æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–

ç³»ç»Ÿä½¿ç”¨æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–æ€§èƒ½ï¼š
```csharp
// ä¸€æ¬¡æ€§æŸ¥è¯¢æ‰€æœ‰åº”ä»˜æ˜ç»†
var debtDetails = await _debtDetailRepository.GetByIdsAsync(debtDetailIds);

// ä¸€æ¬¡æ€§æŸ¥è¯¢æ‰€æœ‰ä¾›åº”å•†
var agents = await _agentRepository.GetByIdsAsync(agentIds);
```

### äº‹åŠ¡ç®¡ç†

ä½¿ç”¨å·¥ä½œå•å…ƒæ¨¡å¼ç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼š
```csharp
await _paymentAutoItemRepository.AddAsync(item);
await _unitOfWork.SaveChangesAsync();
```

## ç›¸å…³API

- **æŸ¥è¯¢è¯¦æƒ…**: `GET /api/payment-auto/{id}`
- **æ›´æ–°**: `PUT /api/payment-auto/{id}`
- **åˆ é™¤**: `DELETE /api/payment-auto/{id}`
- **æäº¤**: `POST /api/payment-auto/{id}/submit`
- **è®¡ç®—æ€»é‡‘é¢**: `GET /api/payment-auto/{id}/total-amount`
- **éªŒè¯æ•°æ®**: `GET /api/payment-auto/{id}/validate`

## æ€»ç»“

âœ… **å¢åŠ åŠŸèƒ½å·²å®Œæ•´å®ç°**ï¼š
- åˆ›å»ºæ‰¹é‡ä»˜æ¬¾å•API
- è‡ªåŠ¨ç”Ÿæˆå•å·
- è‡ªåŠ¨å…³è”ä¾›åº”å•†
- å®Œæ•´çš„æ•°æ®éªŒè¯
- ç»Ÿä¸€çš„é”™è¯¯å¤„ç†

âœ… **æ”¯æŒçš„åœºæ™¯**ï¼š
- å•ä¾›åº”å•†æ‰¹é‡ä»˜æ¬¾
- å¤šä¾›åº”å•†æ‰¹é‡ä»˜æ¬¾
- è·¨éƒ¨é—¨æ‰¹é‡ä»˜æ¬¾
- å¸¦é™„ä»¶çš„æ‰¹é‡ä»˜æ¬¾

ğŸ¯ **ä½¿ç”¨å»ºè®®**ï¼š
- å…ˆé€‰æ‹©åº”ä»˜æ˜ç»†
- ç¡®è®¤å…¬å¸å’Œéƒ¨é—¨ä¿¡æ¯
- æ·»åŠ å¿…è¦çš„å¤‡æ³¨
- åˆ›å»ºåå¯ç»§ç»­ç¼–è¾‘
- ç¡®è®¤æ— è¯¯åæäº¤å®¡æ‰¹
