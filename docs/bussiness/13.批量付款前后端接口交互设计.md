# 批量付款管理 - 前后端接口交互设计

## 1. 后端服务配置

### 1.1 后端地址（开发环境）

- **HTTPS**: `https://localhost:61801`
- **HTTP**: `http://localhost:61803`
- **配置文件**: `Finance/src/Inno.CorePlatform.Finance.Backend/Properties/launchSettings.json`

### 1.2 API 基础路径

```
/api/payment-auto
```

---

## 2. 核心用例与 API 端点设计

### 2.1 查询应付明细（用于新增/编辑时勾选）

**用例**：用户选择核算部门、公司后，查询可用的应付明细列表供勾选。

**端点**：`GET /api/payment-auto/debt-details`

**请求参数**（Query String）：

| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| companyId | Guid | 是 | 公司ID |
| departmentId | string | 否 | 核算部门当前ID |
| agentId | Guid | 否 | 供应商ID（筛选） |
| debtNo | string | 否 | 应付单号（筛选） |
| page | int | 否 | 页码（默认1） |
| limit | int | 否 | 每页条数（默认20） |

**响应示例**：

```json
{
  "content": [
    {
      "id": "dddddddd-dddd-dddd-dddd-dddddddddddd",
      "debtNo": "AP202512150001",
      "debtId": "eeeeeeee-eeee-eeee-eeee-eeeeeeeeeeee",
      "agentId": "aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa",
      "agentName": "上海XX贸易有限公司",
      "expectedPayDate": "2025-12-20T00:00:00",
      "payableAmount": 50000.00,
      "remainingAmount": 50000.00,
      "debtType": "采购应付",
      "businessUnit": "采购BU",
      "currency": "CNY",
      "purchaseContractNo": "PO-2025-0001"
    }
  ],
  "totalElements": 1,
  "page": 1,
  "size": 20
}
```

---

### 2.2 新增批量付款单

**用例**：用户勾选应付明细后，提交创建批量付款单（单头+明细+供应商表）。

**端点**：`POST /api/payment-auto`

**请求体**：

```json
{
  "departmentIdPath": "01/0101",
  "departmentNamePath": "总部/财务部",
  "departmentCurrentId": "0101",
  "companyId": "11111111-1111-1111-1111-111111111111",
  "companyName": "总部公司",
  "companyCode": "C001",
  "remark": "12月批量付款",
  "attachmentIds": "",
  "details": [
    {
      "debtDetailId": "dddddddd-dddd-dddd-dddd-dddddddddddd",
      "paymentAmount": 50000.00
    }
  ]
}
```

**响应示例**：

```json
{
  "success": true,
  "data": {
    "id": "ffffffff-ffff-ffff-ffff-ffffffffffff",
    "code": "PAY202512150001",
    "billDate": "2025-12-15T10:30:00",
    "status": 0,
    "statusDescription": "待提交"
  },
  "message": "批量付款单创建成功"
}
```

**后端处理逻辑**：

1. **生成单头**：
   - 自动生成唯一单号（`PAY + yyyyMMdd + 序号`）
   - 单据日期为当前日期
   - 状态设为 `0`（待提交）
   - 插入 `PaymentAutoItem` 表

2. **生成明细**：
   - 遍历 `details`，插入 `PaymentAutoDetail` 表
   - 关联 `PaymentAutoItemId` 与 `DebtDetailId`

3. **自动生成供应商表**：
   - 根据应付明细关联的应付表，提取供应商信息（去重）
   - 从 `Agent` 表查询银行账号信息
   - 插入 `PaymentAutoAgent` 表

---

### 2.3 查询批量付款单列表

**用例**：用户查询批量付款单列表，支持按状态、公司、供应商筛选。

**端点**：`GET /api/payment-auto`

**请求参数**（Query String）：

| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| status | int | 否 | 状态（0:待提交,1:审批中,2:已完成,11:已驳回） |
| companyId | Guid | 否 | 公司ID |
| agentId | Guid | 否 | 供应商ID |
| code | string | 否 | 批量付款单号 |
| page | int | 否 | 页码（默认1） |
| limit | int | 否 | 每页条数（默认20） |

**响应示例**：

```json
{
  "list": [
    {
      "id": "ffffffff-ffff-ffff-ffff-ffffffffffff",
      "code": "PAY202512150001",
      "billDate": "2025-12-15T10:30:00",
      "companyName": "总部公司",
      "sumValue": 50000.00,
      "status": 0,
      "statusDescription": "待提交",
      "probablyPayTime": "2025-12-20",
      "remark": "12月批量付款",
      "createdBy": "张三"
    }
  ],
  "total": 1
}
```

---

### 2.4 查询批量付款单详情

**用例**：用户点击某条批量付款单，查看详情（单头+明细+供应商）。

**端点**：`GET /api/payment-auto/{id}`

**路径参数**：

| 参数名 | 类型 | 说明 |
|-------|------|------|
| id | Guid | 批量付款单ID |

**响应示例**：

```json
{
  "id": "ffffffff-ffff-ffff-ffff-ffffffffffff",
  "code": "PAY202512150001",
  "billDate": "2025-12-15T10:30:00",
  "companyId": "11111111-1111-1111-1111-111111111111",
  "companyName": "总部公司",
  "companyCode": "C001",
  "departmentIdPath": "01/0101",
  "departmentNamePath": "总部/财务部",
  "departmentCurrentId": "0101",
  "status": 0,
  "statusDescription": "待提交",
  "remark": "12月批量付款",
  "attachmentIds": "",
  "details": [
    {
      "id": "aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa",
      "debtDetailId": "dddddddd-dddd-dddd-dddd-dddddddddddd",
      "debtNo": "AP202512150001",
      "paymentAmount": 50000.00,
      "expectedPayDate": "2025-12-20"
    }
  ],
  "agents": [
    {
      "id": "bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb",
      "agentId": "aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa",
      "agentName": "上海XX贸易有限公司",
      "accountName": "上海XX贸易有限公司",
      "accountNo": "6222020202020202",
      "bankName": "中国工商银行上海分行",
      "bankCode": "ICBKSH01",
      "sum": 50000.00,
      "remark": ""
    }
  ]
}
```

---

### 2.5 编辑批量付款单

**用例**：用户编辑待提交状态的批量付款单，重新勾选应付明细。

**端点**：`PUT /api/payment-auto/{id}`

**路径参数**：

| 参数名 | 类型 | 说明 |
|-------|------|------|
| id | Guid | 批量付款单ID |

**请求体**：

```json
{
  "departmentIdPath": "01/0101",
  "departmentNamePath": "总部/财务部",
  "departmentCurrentId": "0101",
  "companyId": "11111111-1111-1111-1111-111111111111",
  "companyName": "总部公司",
  "companyCode": "C001",
  "remark": "12月批量付款（已修改）",
  "attachmentIds": "",
  "details": [
    {
      "debtDetailId": "dddddddd-dddd-dddd-dddd-dddddddddddd",
      "paymentAmount": 45000.00
    }
  ]
}
```

**响应示例**：

```json
{
  "success": true,
  "message": "批量付款单更新成功"
}
```

**后端处理逻辑**：

1. 验证状态为"待提交"（`status == 0`）
2. 更新单头信息
3. 删除原有明细与供应商记录
4. 重新生成明细与供应商表（逻辑同新增）

---

### 2.6 删除批量付款单

**用例**：用户删除待提交状态的批量付款单。

**端点**：`DELETE /api/payment-auto/{id}`

**路径参数**：

| 参数名 | 类型 | 说明 |
|-------|------|------|
| id | Guid | 批量付款单ID |

**响应示例**：

```json
{
  "success": true,
  "message": "批量付款单删除成功"
}
```

**后端处理逻辑**：

1. 验证状态为"待提交"（`status == 0`）
2. 软删除（`IsDeleted = true`）或物理删除单头、明细、供应商记录

---

## 3. 前后端交互流程

### 3.1 新增批量付款单流程

```
[前端] 用户选择核算部门、公司
   ↓
[前端] 调用 GET /api/payment-auto/debt-details 查询可用应付明细
   ↓
[后端] 返回应付明细列表（含供应商、金额、账期等）
   ↓
[前端] 用户勾选应付明细，填写备注
   ↓
[前端] 调用 POST /api/payment-auto 提交创建请求
   ↓
[后端] 生成单头（自动单号、日期、状态=待提交）
[后端] 生成明细（关联应付明细ID）
[后端] 自动生成供应商表（从应付表提取供应商，查询银行账号）
   ↓
[后端] 返回创建成功响应（含单号、ID）
   ↓
[前端] 显示成功提示，跳转到列表页
```

### 3.2 编辑批量付款单流程

```
[前端] 用户点击列表中"待提交"状态的记录
   ↓
[前端] 调用 GET /api/payment-auto/{id} 查询详情
   ↓
[后端] 返回单头、明细、供应商信息
   ↓
[前端] 自动带入核算部门、公司信息，显示已勾选的应付明细
   ↓
[前端] 用户修改勾选、金额、备注
   ↓
[前端] 调用 PUT /api/payment-auto/{id} 提交更新请求
   ↓
[后端] 验证状态为"待提交"
[后端] 更新单头，删除旧明细/供应商，重新生成
   ↓
[后端] 返回更新成功响应
   ↓
[前端] 显示成功提示，刷新列表
```

### 3.3 删除批量付款单流程

```
[前端] 用户勾选"待提交"状态的记录，点击删除
   ↓
[前端] 弹出确认对话框
   ↓
[前端] 调用 DELETE /api/payment-auto/{id}
   ↓
[后端] 验证状态为"待提交"
[后端] 软删除或物理删除记录
   ↓
[后端] 返回删除成功响应
   ↓
[前端] 显示成功提示，刷新列表
```

---

## 4. DTO 结构建议

### 4.1 CreatePaymentAutoCommand（新增请求）

```csharp
public class CreatePaymentAutoCommand
{
    public string DepartmentIdPath { get; set; }
    public string DepartmentNamePath { get; set; }
    public string DepartmentCurrentId { get; set; }
    public Guid CompanyId { get; set; }
    public string CompanyName { get; set; }
    public string CompanyCode { get; set; }
    public string? Remark { get; set; }
    public string? AttachmentIds { get; set; }
    public List<PaymentAutoDetailDto> Details { get; set; }
}

public class PaymentAutoDetailDto
{
    public Guid DebtDetailId { get; set; }
    public decimal PaymentAmount { get; set; }
}
```

### 4.2 UpdatePaymentAutoCommand（编辑请求）

```csharp
public class UpdatePaymentAutoCommand
{
    public Guid Id { get; set; }
    public string DepartmentIdPath { get; set; }
    public string DepartmentNamePath { get; set; }
    public string DepartmentCurrentId { get; set; }
    public Guid CompanyId { get; set; }
    public string CompanyName { get; set; }
    public string CompanyCode { get; set; }
    public string? Remark { get; set; }
    public string? AttachmentIds { get; set; }
    public List<PaymentAutoDetailDto> Details { get; set; }
}
```

### 4.3 PaymentAutoDto（查询响应）

```csharp
public class PaymentAutoDto
{
    public Guid Id { get; set; }
    public string Code { get; set; }
    public DateTime BillDate { get; set; }
    public Guid CompanyId { get; set; }
    public string CompanyName { get; set; }
    public string CompanyCode { get; set; }
    public string DepartmentIdPath { get; set; }
    public string DepartmentNamePath { get; set; }
    public string DepartmentCurrentId { get; set; }
    public int Status { get; set; }
    public string StatusDescription { get; set; }
    public decimal SumValue { get; set; }
    public string? Remark { get; set; }
    public string? AttachmentIds { get; set; }
    public List<PaymentAutoDetailDto> Details { get; set; }
    public List<PaymentAutoAgentDto> Agents { get; set; }
}

public class PaymentAutoAgentDto
{
    public Guid Id { get; set; }
    public Guid AgentId { get; set; }
    public string AgentName { get; set; }
    public string AccountName { get; set; }
    public string AccountNo { get; set; }
    public string BankName { get; set; }
    public string BankCode { get; set; }
    public decimal Sum { get; set; }
    public string? Remark { get; set; }
}
```

### 4.4 DebtDetailQueryDto（应付明细查询响应）

```csharp
public class DebtDetailQueryDto
{
    public Guid Id { get; set; }
    public string DebtNo { get; set; }
    public Guid DebtId { get; set; }
    public Guid AgentId { get; set; }
    public string AgentName { get; set; }
    public DateTime ExpectedPayDate { get; set; }
    public decimal PayableAmount { get; set; }
    public decimal RemainingAmount { get; set; }
    public string DebtType { get; set; }
    public string BusinessUnit { get; set; }
    public string Currency { get; set; }
    public string? PurchaseContractNo { get; set; }
    public string? ProjectName { get; set; }
}
```

---

## 5. 关键业务规则

### 5.1 供应商自动生成逻辑

1. **提取供应商**：从勾选的应付明细关联的应付表中，提取所有供应商ID（去重）
2. **查询银行账号**：从 `Agent` 表查询供应商的银行账号信息（账号名称、账号、开户行等）
3. **计算付款金额**：按供应商汇总所有明细的付款金额
4. **插入供应商表**：生成 `PaymentAutoAgent` 记录

### 5.2 状态流转规则

| 状态 | 说明 | 允许操作 |
|------|------|---------|
| 0 | 待提交 | 编辑、删除、提交审批 |
| 1 | 审批中 | 查看、撤回 |
| 2 | 已完成 | 查看 |
| 11 | 已驳回 | 编辑、删除、重新提交 |

### 5.3 数据验证规则

- **新增/编辑时**：
  - 必须选择至少一条应付明细
  - 付款金额不能超过应付明细的剩余金额
  - 核算部门、公司必填
  
- **删除时**：
  - 只能删除"待提交"状态的记录
  
- **编辑时**：
  - 只能编辑"待提交"状态的记录

---

## 6. 前端实现建议

### 6.1 页面结构

```
批量付款管理页面
├── 查询区域（公司、供应商、应付单号筛选）
├── 操作按钮（新增、编辑、删除）
├── 列表区域（Tab切换：待提交/审批中/已完成/已驳回/全部）
└── 详情/编辑弹窗
    ├── 单头信息（核算部门、公司、备注）
    ├── 应付明细表格（勾选、金额、账期）
    └── 供应商信息表格（自动生成，只读）
```

### 6.2 前端调用示例（Vue 3 + Axios）

```typescript
// 查询应付明细
async function fetchDebtDetails(params: DebtDetailQueryParams) {
  const response = await axios.get('https://localhost:61801/api/payment-auto/debt-details', {
    params
  });
  return response.data;
}

// 新增批量付款单
async function createPaymentAuto(command: CreatePaymentAutoCommand) {
  const response = await axios.post('https://localhost:61801/api/payment-auto', command);
  return response.data;
}

// 查询批量付款单列表
async function fetchPaymentAutoList(params: PaymentAutoQueryParams) {
  const response = await axios.get('https://localhost:61801/api/payment-auto', {
    params
  });
  return response.data;
}

// 查询批量付款单详情
async function fetchPaymentAutoDetail(id: string) {
  const response = await axios.get(`https://localhost:61801/api/payment-auto/${id}`);
  return response.data;
}

// 编辑批量付款单
async function updatePaymentAuto(id: string, command: UpdatePaymentAutoCommand) {
  const response = await axios.put(`https://localhost:61801/api/payment-auto/${id}`, command);
  return response.data;
}

// 删除批量付款单
async function deletePaymentAuto(id: string) {
  const response = await axios.delete(`https://localhost:61801/api/payment-auto/${id}`);
  return response.data;
}
```

---

## 7. 后端实现建议

### 7.1 Controller 结构

```csharp
[ApiController]
[Route("api/payment-auto")]
public class PaymentAutoController : ControllerBase
{
    private readonly IPaymentAutoApplicationService _service;

    [HttpGet("debt-details")]
    public async Task<IActionResult> GetDebtDetails([FromQuery] DebtDetailQueryParams query)
    {
        // 查询应付明细
    }

    [HttpPost]
    public async Task<IActionResult> Create([FromBody] CreatePaymentAutoCommand command)
    {
        // 新增批量付款单
    }

    [HttpGet]
    public async Task<IActionResult> GetList([FromQuery] PaymentAutoQueryParams query)
    {
        // 查询批量付款单列表
    }

    [HttpGet("{id}")]
    public async Task<IActionResult> GetDetail(Guid id)
    {
        // 查询批量付款单详情
    }

    [HttpPut("{id}")]
    public async Task<IActionResult> Update(Guid id, [FromBody] UpdatePaymentAutoCommand command)
    {
        // 编辑批量付款单
    }

    [HttpDelete("{id}")]
    public async Task<IActionResult> Delete(Guid id)
    {
        // 删除批量付款单
    }
}
```

### 7.2 Application Service 核心逻辑

```csharp
public class PaymentAutoApplicationService : IPaymentAutoApplicationService
{
    private readonly IPaymentAutoItemRepository _itemRepository;
    private readonly IPaymentAutoDetailRepository _detailRepository;
    private readonly IPaymentAutoAgentRepository _agentRepository;
    private readonly IDebtDetailRepository _debtDetailRepository;
    private readonly IAgentRepository _agentRepository;
    private readonly IUnitOfWork _unitOfWork;

    public async Task<PaymentAutoDto> CreateAsync(CreatePaymentAutoCommand command)
    {
        // 1. 生成单头
        var item = PaymentAutoItem.Create(
            code: GenerateCode(),
            billDate: DateTime.Now,
            companyId: command.CompanyId,
            // ... 其他字段
        );

        // 2. 生成明细
        foreach (var detail in command.Details)
        {
            var debtDetail = await _debtDetailRepository.GetByIdAsync(detail.DebtDetailId);
            item.AddDetail(debtDetail.Id, detail.PaymentAmount);
        }

        // 3. 自动生成供应商表
        var agentIds = await GetAgentIdsFromDebtDetails(command.Details);
        foreach (var agentId in agentIds)
        {
            var agent = await _agentRepository.GetByIdAsync(agentId);
            var sum = CalculateAgentSum(command.Details, agentId);
            item.AddAgent(agent, sum);
        }

        // 4. 保存
        await _itemRepository.AddAsync(item);
        await _unitOfWork.CommitAsync();

        return MapToDto(item);
    }

    private string GenerateCode()
    {
        // PAY + yyyyMMdd + 序号
        var today = DateTime.Now.ToString("yyyyMMdd");
        var count = await _itemRepository.CountTodayAsync();
        return $"PAY{today}{(count + 1):D4}";
    }
}
```

---

## 8. 注意事项

1. **并发控制**：编辑/删除时需验证状态，避免并发修改导致数据不一致
2. **事务管理**：新增/编辑/删除操作必须在同一事务中完成（单头+明细+供应商）
3. **权限控制**：需根据用户角色控制操作权限（如：只能操作本部门的批量付款单）
4. **审计日志**：记录创建人、创建时间、更新人、更新时间
5. **软删除**：建议使用软删除（`IsDeleted = true`），保留历史数据
6. **金额精度**：所有金额字段使用 `decimal(18,2)`，避免精度丢失
7. **供应商命名**：统一使用 `Agent`（领域模型）而非 `Supplier`

---

## 9. 测试建议

### 9.1 单元测试

- 测试单号生成逻辑
- 测试供应商自动生成逻辑
- 测试状态验证逻辑

### 9.2 集成测试

- 测试完整的新增流程
- 测试完整的编辑流程
- 测试完整的删除流程
- 测试并发修改场景

### 9.3 前端测试

- 测试应付明细勾选交互
- 测试供应商表自动刷新
- 测试表单验证
- 测试列表筛选与分页

---

## 10. 后续优化方向

1. **批量操作**：支持批量删除、批量提交审批
2. **导出功能**：支持导出批量付款单为 Excel
3. **审批流集成**：集成 OA 审批流，支持审批状态同步
4. **消息通知**：审批完成后通知申请人
5. **数据统计**：提供批量付款单统计报表（按公司、供应商、时间维度）
