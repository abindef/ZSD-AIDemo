# 批量付款新增功能详细设计

## 一、功能概述

批量付款新增功能允许用户从应付明细中选择需要付款的记录，自动生成批量付款单。系统会自动关联供应商信息和银行账号，支持多供应商批量付款。

## 二、界面设计

### 2.1 新增批量付款单弹窗

**弹窗标题**：选取单据

**弹窗尺寸**：宽度 90%，高度自适应

**布局结构**：
- 查询条件区域（顶部）
- 标签页切换区域
- 数据表格区域（主体）
- 统计信息区域（底部左侧）
- 操作按钮区域（底部右侧）

### 2.2 查询条件区域

**第一行查询条件**：

| 字段名 | 控件类型 | 宽度 | 必填 | 说明 |
|--------|---------|------|------|------|
| 核算部门 | 树形选择器 | 200px | 否 | 选择核算部门，支持多级部门树 |
| 公司 | 下拉选择 | 200px | 是 | 选择公司，必填项 |
| 客户 | 输入框 | 200px | 否 | 输入客户名称，支持模糊查询 |
| 过滤条件 | 下拉选择 | 200px | 否 | 预设的过滤条件 |

**第二行查询条件**：

| 字段名 | 控件类型 | 宽度 | 必填 | 说明 |
|--------|---------|------|------|------|
| 应付单号 | 输入框 | 200px | 否 | 输入应付单号，支持模糊查询 |
| 应付单类型 | 下拉选择 | 200px | 否 | 选择应付单据类型 |
| 入库单号 | 输入框 | 200px | 否 | 输入入库单号 |
| 过滤条件2 | 下拉选择 | 200px | 否 | 第二个过滤条件 |

**第三行查询条件**：

| 字段名 | 控件类型 | 宽度 | 必填 | 说明 |
|--------|---------|------|------|------|
| 供应商 | 输入框 | 200px | 否 | 输入供应商名称，支持模糊查询 |
| 预计付款日期 | 日期范围 | 400px | 否 | 选择预计付款日期范围 |
| 实际付款日期 | 日期范围 | 400px | 否 | 选择实际付款日期范围 |

**操作按钮**：
- 查询（主按钮，蓝色）
- 导出（普通按钮）

### 2.3 标签页区域

**标签页列表**：
- 所有付款明细（默认选中）
- 入库单明细
- 供货单明细
- 应收单明细
- 应收明细
- 应收类型明细

**说明**：点击不同标签页，切换显示不同类型的应付明细数据。

### 2.4 数据表格区域

**表格配置**：
- 支持多选（复选框）
- 支持排序
- 支持列宽调整
- 表头固定
- 最大高度：500px，超出滚动

**表格列定义**：

| 序号 | 列名 | 字段名 | 宽度 | 对齐 | 排序 | 说明 |
|------|------|--------|------|------|------|------|
| 1 | 复选框 | - | 55px | 居中 | - | 多选框 |
| 2 | 序号 | - | 60px | 居中 | - | 自动序号 |
| 3 | 供应商 | AgentName | 150px | 左对齐 | 是 | 供应商名称 |
| 4 | 公司 | CompanyName | 120px | 左对齐 | 是 | 公司名称 |
| 5 | 应付单号 | DebtCode | 180px | 左对齐 | 是 | 应付单号，可点击查看详情 |
| 6 | 应付单类型 | DocumentType | 100px | 居中 | 是 | 单据类型（AC101等） |
| 7 | 应付单类型名称 | DocumentTypeName | 120px | 左对齐 | 是 | 类型名称 |
| 8 | 预计付款日期 | ExpectedPaymentDate | 120px | 居中 | 是 | 格式：YYYY-MM-DD |
| 9 | 客户 | Customer | 100px | 左对齐 | 是 | 客户名称 |
| 10 | 应付金额 | PaymentAmount | 120px | 右对齐 | 是 | 千分位，保留2位小数 |
| 11 | 承诺金额 | CommitmentAmount | 120px | 右对齐 | 是 | 千分位，保留2位小数 |
| 12 | 付款金额 | PaidAmount | 120px | 右对齐 | 是 | 千分位，保留2位小数 |
| 13 | 剩余金额 | RemainingAmount | 120px | 右对齐 | 是 | 千分位，保留2位小数 |
| 14 | 应付明细编号 | DebtDetailCode | 180px | 左对齐 | 是 | 应付明细编号 |
| 15 | 供应商编号 | AgentCode | 150px | 左对齐 | 是 | 供应商编码 |
| 16 | 付款明细编号 | PaymentDetailCode | 180px | 左对齐 | 是 | 付款明细编号 |
| 17 | 操作 | - | 100px | 居中 | - | 操作按钮 |

**操作列按钮**：
- 选择（链接按钮）：单独选择该条记录
- 已选择（绿色标签）：已被选中的记录显示

### 2.5 底部统计区域

**左侧统计信息**：
```
已选择 X 条  合计金额：0.00
```

**说明**：
- 实时显示已选择的记录数量
- 实时计算已选择记录的剩余金额总和
- 金额格式：千分位分隔，保留两位小数

**右侧操作按钮**：
- 取消（普通按钮）：关闭弹窗，不保存选择
- 确定（主按钮，蓝色）：确认选择，生成批量付款单

## 三、业务流程

### 3.1 打开选取单据弹窗

**触发条件**：
- 用户点击批量付款列表页的"增加"按钮
- 或点击编辑页面的"选择应付明细"按钮

**执行步骤**：
1. 打开"选取单据"弹窗
2. 默认显示"所有付款明细"标签页
3. 如果是编辑模式，自动反选已选择的应付明细
4. 加载应付明细数据（默认查询条件）

### 3.2 查询应付明细

**查询逻辑**：

```typescript
// 查询条件
interface DebtDetailQueryDto {
  // 第一行
  departmentIdPath?: string;      // 核算部门ID路径
  companyId?: string;              // 公司ID（必填）
  customer?: string;               // 客户
  filter1?: string;                // 过滤条件1
  
  // 第二行
  debtCode?: string;               // 应付单号
  documentType?: string;           // 应付单类型
  inboundCode?: string;            // 入库单号
  filter2?: string;                // 过滤条件2
  
  // 第三行
  agentName?: string;              // 供应商
  expectedPaymentDateStart?: Date; // 预计付款日期开始
  expectedPaymentDateEnd?: Date;   // 预计付款日期结束
  actualPaymentDateStart?: Date;   // 实际付款日期开始
  actualPaymentDateEnd?: Date;     // 实际付款日期结束
  
  // 标签页
  tabType?: string;                // 标签页类型
  
  // 分页
  page: number;
  pageSize: number;
}
```

**查询API**：
```
GET /api/debt-details/available-for-payment
```

**返回数据**：
```typescript
interface DebtDetailDto {
  id: string;                      // 应付明细ID
  debtId: string;                  // 应付单ID
  debtCode: string;                // 应付单号
  agentId: string;                 // 供应商ID
  agentName: string;               // 供应商名称
  agentCode: string;               // 供应商编码
  companyId: string;               // 公司ID
  companyName: string;             // 公司名称
  documentType: string;            // 单据类型代码
  documentTypeName: string;        // 单据类型名称
  customer: string;                // 客户
  expectedPaymentDate: Date;       // 预计付款日期
  paymentAmount: number;           // 应付金额
  commitmentAmount: number;        // 承诺金额
  paidAmount: number;              // 已付金额
  remainingAmount: number;         // 剩余金额
  debtDetailCode: string;          // 应付明细编号
  paymentDetailCode: string;       // 付款明细编号
  
  // 扩展信息（用于生成批量付款单）
  departmentIdPath: string;        // 部门ID路径
  departmentNamePath: string;      // 部门名称路径
  departmentCurrentId: string;     // 当前部门ID
  companyCode: string;             // 公司编码
  paymentTermType: string;         // 账期类型
}
```

**数据过滤规则**：
1. 只查询未删除的应付明细（IsDeleted = false）
2. 只查询剩余金额大于0的记录（RemainingAmount > 0）
3. 排除已在其他待提交批量付款单中的明细
4. 按预计付款日期升序排列

### 3.3 选择应付明细

**选择方式**：

1. **单选**：点击操作列的"选择"按钮
2. **多选**：勾选复选框
3. **全选**：勾选表头的全选复选框（当前页全选）

**选择限制**：
- 不能选择剩余金额为0的记录
- 不能选择已被其他批量付款单占用的记录
- 可以跨页选择

**选中状态**：
- 已选中的行高亮显示
- 操作列显示"已选择"绿色标签
- 底部统计实时更新

### 3.4 确认选择

**点击"确定"按钮**：

1. **验证选择**：
   - 至少选择一条应付明细
   - 所有选中的记录剩余金额必须大于0

2. **数据处理**：
   ```typescript
   // 按供应商分组
   const groupedByAgent = selectedDetails.reduce((acc, detail) => {
     if (!acc[detail.agentId]) {
       acc[detail.agentId] = {
         agentId: detail.agentId,
         agentName: detail.agentName,
         agentCode: detail.agentCode,
         details: []
       };
     }
     acc[detail.agentId].details.push(detail);
     return acc;
   }, {});
   
   // 提取公司和部门信息（取第一条记录）
   const firstDetail = selectedDetails[0];
   const companyInfo = {
     companyId: firstDetail.companyId,
     companyName: firstDetail.companyName,
     companyCode: firstDetail.companyCode
   };
   
   const departmentInfo = {
     departmentIdPath: firstDetail.departmentIdPath,
     departmentNamePath: firstDetail.departmentNamePath,
     departmentCurrentId: firstDetail.departmentCurrentId
   };
   ```

3. **关闭弹窗**：
   - 将选中的应付明细数据传递给父组件
   - 关闭选取单据弹窗

### 3.5 生成批量付款单

**在父组件中处理**：

1. **填充表单数据**：
   ```typescript
   form.companyId = companyInfo.companyId;
   form.companyName = companyInfo.companyName;
   form.companyCode = companyInfo.companyCode;
   form.departmentIdPath = departmentInfo.departmentIdPath;
   form.departmentNamePath = departmentInfo.departmentNamePath;
   form.departmentCurrentId = departmentInfo.departmentCurrentId;
   
   // 填充明细
   form.details = selectedDetails.map(detail => ({
     debtDetailId: detail.id,
     debtCode: detail.debtCode,
     agentId: detail.agentId,
     agentName: detail.agentName,
     debtAmount: detail.paymentAmount,
     remainingAmount: detail.remainingAmount,
     paymentAmount: detail.remainingAmount, // 默认付款金额=剩余金额
     expectedPaymentDate: detail.expectedPaymentDate,
     paymentTermType: detail.paymentTermType
   }));
   ```

2. **显示明细表格**：
   - 在新增/编辑表单中显示选中的应付明细
   - 用户可以调整每条明细的付款金额
   - 用户可以删除不需要的明细

3. **实时汇总**：
   ```typescript
   // 明细数量
   const detailCount = form.details.length;
   
   // 供应商数量
   const agentIds = new Set(form.details.map(d => d.agentId));
   const agentCount = agentIds.size;
   
   // 总金额
   const totalAmount = form.details.reduce((sum, d) => sum + d.paymentAmount, 0);
   ```

### 3.6 保存批量付款单

**点击"保存"按钮**：

1. **表单验证**：
   - 公司信息必填
   - 至少包含一条明细
   - 每条明细的付款金额必须大于0且不超过剩余金额

2. **调用创建API**：
   ```typescript
   POST /api/payment-auto
   
   {
     companyId: "guid",
     companyName: "总部公司",
     companyCode: "C001",
     departmentIdPath: "01/0101",
     departmentNamePath: "总部/财务部",
     departmentCurrentId: "0101",
     remark: "备注信息",
     details: [
       {
         debtDetailId: "guid",
         paymentAmount: 50000.00
       }
     ]
   }
   ```

3. **后端处理**：
   - 生成批量付款单号（PAY{日期}{序号}）
   - 创建 PaymentAutoItem 记录
   - 创建 PaymentAutoDetail 记录
   - 查询供应商银行账号信息
   - 创建 PaymentAutoAgent 记录
   - 返回完整的批量付款单数据

4. **前端处理**：
   - 关闭新增/编辑弹窗
   - 刷新批量付款单列表
   - 显示成功提示

## 四、数据关联关系

### 4.1 应付明细 → 批量付款明细

```
DebtDetail (应付明细)
    ↓ (1:N)
PaymentAutoDetail (批量付款明细)
```

**关联字段**：
- `PaymentAutoDetail.DebtDetailId` = `DebtDetail.Id`

**业务规则**：
- 一个应付明细可以被多个批量付款单引用（分批付款）
- 所有批量付款明细的付款金额之和不能超过应付明细的应付金额

### 4.2 应付明细 → 应付单 → 供应商

```
DebtDetail (应付明细)
    ↓ (N:1)
Debt (应付单)
    ↓ (N:1)
Agent (供应商)
```

**关联字段**：
- `DebtDetail.DebtId` = `Debt.Id`
- `Debt.AgentId` = `Agent.Id`

**数据提取**：
- 从应付明细获取应付单ID
- 从应付单获取供应商ID
- 从供应商获取银行账号信息

### 4.3 批量付款单 → 批量付款供应商

```
PaymentAutoItem (批量付款单)
    ↓ (1:N)
PaymentAutoAgent (批量付款供应商)
```

**关联字段**：
- `PaymentAutoAgent.PaymentAutoItemId` = `PaymentAutoItem.Id`
- `PaymentAutoAgent.AgentId` = `Agent.Id`

**生成规则**：
- 从批量付款明细中提取所有唯一的供应商ID
- 查询供应商的银行账号信息
- 为每个供应商创建一条 PaymentAutoAgent 记录

## 五、字段映射关系

### 5.1 应付明细 → 批量付款单头

| 应付明细字段 | 批量付款单头字段 | 取值规则 |
|-------------|-----------------|---------|
| CompanyId | CompanyId | 取第一条明细的公司ID |
| CompanyName | CompanyName | 取第一条明细的公司名称 |
| CompanyCode | CompanyCode | 取第一条明细的公司编码 |
| DepartmentIdPath | DepartmentIdPath | 取第一条明细的部门ID路径 |
| DepartmentNamePath | DepartmentNamePath | 取第一条明细的部门名称路径 |
| DepartmentCurrentId | DepartmentCurrentId | 取第一条明细的当前部门ID |
| - | Code | 系统自动生成 |
| - | BillDate | 当前日期 |
| - | Status | 固定为0（待提交） |
| - | TotalAmount | 所有明细付款金额之和 |

### 5.2 应付明细 → 批量付款明细

| 应付明细字段 | 批量付款明细字段 | 取值规则 |
|-------------|-----------------|---------|
| Id | DebtDetailId | 应付明细ID |
| RemainingAmount | PaymentAmount | 默认为剩余金额，用户可调整 |

### 5.3 供应商 → 批量付款供应商

| 供应商字段 | 批量付款供应商字段 | 取值规则 |
|-----------|-------------------|---------|
| Id | AgentId | 供应商ID |
| Name | AgentName | 供应商名称 |
| BankAccountName | AccountName | 银行账户名称 |
| BankAccountNo | AccountNo | 银行账号 |
| BankName | BankName | 开户行名称 |
| BankCode | BankCode | 开户行编码 |

## 六、验证规则

### 6.1 查询验证

- 公司必须选择（必填项）
- 日期范围：开始日期不能大于结束日期
- 至少提供一个查询条件

### 6.2 选择验证

- 至少选择一条应付明细
- 选中的应付明细剩余金额必须大于0
- 不能选择已被其他待提交批量付款单占用的明细

### 6.3 金额验证

- 付款金额必须大于0
- 付款金额不能超过应付明细的剩余金额
- 付款金额最多保留2位小数

### 6.4 保存验证

- 公司信息必填
- 至少包含一条明细
- 所有明细的付款金额必须有效
- 必须至少关联一个供应商

## 七、异常处理

### 7.1 查询异常

**场景**：查询应付明细失败

**处理**：
- 显示错误提示："查询应付明细失败，请稍后重试"
- 记录错误日志
- 表格显示空数据

### 7.2 选择异常

**场景1**：未选择任何记录就点击确定

**处理**：
- 显示警告提示："请至少选择一条应付明细"
- 不关闭弹窗

**场景2**：选择的记录已被占用

**处理**：
- 显示错误提示："选中的应付明细已被其他批量付款单占用"
- 自动取消选择该记录

### 7.3 保存异常

**场景1**：供应商银行账号信息不完整

**处理**：
- 显示错误提示："供应商 [供应商名称] 的银行账号信息不完整，请先维护供应商信息"
- 不保存数据

**场景2**：应付明细剩余金额不足

**处理**：
- 显示错误提示："应付明细 [应付单号] 的剩余金额不足"
- 不保存数据

## 八、性能优化

### 8.1 分页加载

- 默认每页显示20条记录
- 支持切换每页显示数量（10/20/50/100）
- 使用虚拟滚动优化大数据量渲染

### 8.2 查询优化

- 使用索引优化查询性能
- 查询条件缓存，避免重复查询
- 使用防抖优化输入框查询

### 8.3 数据缓存

- 缓存已查询的应付明细数据
- 缓存供应商信息
- 缓存公司和部门信息

## 九、用户体验优化

### 9.1 智能默认值

- 公司默认选择当前用户所属公司
- 部门默认选择当前用户所属部门
- 付款金额默认为应付明细的剩余金额

### 9.2 快捷操作

- 支持键盘快捷键（Enter查询，Esc取消）
- 支持双击行选择
- 支持拖拽调整列宽

### 9.3 友好提示

- 显示加载动画
- 显示操作成功/失败提示
- 显示实时统计信息
- 高亮显示选中的记录

## 十、测试要点

### 10.1 功能测试

- [ ] 查询功能：各种查询条件组合
- [ ] 选择功能：单选、多选、全选、跨页选择
- [ ] 金额计算：实时汇总、金额格式化
- [ ] 数据关联：供应商自动关联、银行账号提取
- [ ] 保存功能：创建批量付款单、数据完整性

### 10.2 边界测试

- [ ] 空数据：无可选应付明细
- [ ] 大数据量：1000+条应付明细
- [ ] 极限值：付款金额为0.01
- [ ] 并发：多人同时选择同一应付明细

### 10.3 异常测试

- [ ] 网络异常：查询失败、保存失败
- [ ] 数据异常：供应商信息缺失、剩余金额为负
- [ ] 权限异常：无权限查询、无权限创建

### 10.4 性能测试

- [ ] 查询性能：1000条数据查询时间 < 2秒
- [ ] 渲染性能：表格渲染时间 < 1秒
- [ ] 操作响应：选择操作响应时间 < 500ms
