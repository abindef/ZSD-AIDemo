# æ•°æ®åº“è¿ç§»å®ŒæˆæŠ¥å‘Š

## æ‰§è¡Œæ—¶é—´
2025å¹´12æœˆ15æ—¥ 14:38

## LocalDB çŠ¶æ€
âœ… **LocalDB å·²å®‰è£…å¹¶è¿è¡Œ**
- å®ä¾‹åç§°: MSSQLLocalDB
- ç‰ˆæœ¬: 15.0.4382.1
- çŠ¶æ€: Running
- è¿æ¥å­—ç¬¦ä¸²: `Server=(localdb)\\MSSQLLocalDB;Database=Finance;Trusted_Connection=True;TrustServerCertificate=True;`

## è¿ç§»æ‰§è¡Œç»“æœ
âœ… **è¿ç§»æˆåŠŸåˆ›å»ºå¹¶åº”ç”¨**
- è¿ç§»åç§°: `AddPaymentAutoTables`
- è¿ç§»æ–‡ä»¶: `20251215063855_AddPaymentAutoTables.cs`
- æ•°æ®åº“åç§°: `Finance`

## åˆ›å»ºçš„æ•°æ®åº“è¡¨

### 1. PaymentAutoItem (æ‰¹é‡ä»˜æ¬¾å•è¡¨)
**ä¸»é”®**: Id (uniqueidentifier)

**å­—æ®µåˆ—è¡¨**:
- `Id` - Guid, ä¸»é”®
- `Code` - nvarchar(200), å•å·, å”¯ä¸€ç´¢å¼•
- `BillDate` - datetime2, å•æ®æ—¥æœŸ
- `CompanyId` - uniqueidentifier, å…¬å¸ID
- `CompanyName` - nvarchar(200), å…¬å¸åç§°
- `CompanyCode` - nvarchar(50), å…¬å¸ç¼–ç 
- `DepartmentIdPath` - nvarchar(500), éƒ¨é—¨IDè·¯å¾„
- `DepartmentNamePath` - nvarchar(500), éƒ¨é—¨åç§°è·¯å¾„
- `DepartmentCurrentId` - nvarchar(50), å½“å‰éƒ¨é—¨ID
- `Remark` - nvarchar(1000), å¤‡æ³¨
- `OverallRemark` - nvarchar(1000), æ€»ä½“å¤‡æ³¨
- `Status` - int, çŠ¶æ€ (0:å¾…æäº¤, 1:å®¡æ‰¹ä¸­, 2:å·²å®Œæˆ, 11:å·²é©³å›)
- `OARequestId` - nvarchar(100), OAè¯·æ±‚ID
- `OALastApprover` - nvarchar(100), OAæœ€åå®¡æ‰¹äºº
- `OALastApprovalTime` - datetimeoffset, OAæœ€åå®¡æ‰¹æ—¶é—´
- `OAApprovalComment` - nvarchar(500), OAå®¡æ‰¹æ„è§
- `AttachmentIds` - nvarchar(2000), é™„ä»¶IDåˆ—è¡¨
- `CreatedBy` - uniqueidentifier, åˆ›å»ºäºº
- `CreatedAt` - datetime2, åˆ›å»ºæ—¶é—´
- `UpdatedBy` - uniqueidentifier, æ›´æ–°äºº
- `UpdatedAt` - datetime2, æ›´æ–°æ—¶é—´
- `IsDeleted` - bit, æ˜¯å¦åˆ é™¤ (é»˜è®¤å€¼: false)

**ç´¢å¼•**:
- `UK_PaymentAutoItem_Code` - å”¯ä¸€ç´¢å¼• (Code)
- `IX_PaymentAutoItem_IsDeleted` - æ™®é€šç´¢å¼• (IsDeleted)

### 2. PaymentAutoDetail (æ‰¹é‡ä»˜æ¬¾æ˜ç»†è¡¨)
**ä¸»é”®**: Id (uniqueidentifier)
**å¤–é”®**: PaymentAutoItemId â†’ PaymentAutoItem.Id (çº§è”åˆ é™¤)

**å­—æ®µåˆ—è¡¨**:
- `Id` - Guid, ä¸»é”®
- `PaymentAutoItemId` - uniqueidentifier, æ‰¹é‡ä»˜æ¬¾å•ID
- `DebtDetailId` - uniqueidentifier, åº”ä»˜æ˜ç»†ID
- `PaymentNo` - nvarchar(100), ä»˜æ¬¾å•å·
- `PaymentAmount` - decimal(18,2), ä»˜æ¬¾é‡‘é¢
- `PaymentTime` - datetime2, ä»˜æ¬¾æ—¶é—´
- `LimitDiscountAmount` - decimal(18,2), é™é¢æŠ˜æ‰£é‡‘é¢
- `CreatedBy` - uniqueidentifier, åˆ›å»ºäºº
- `CreatedAt` - datetime2, åˆ›å»ºæ—¶é—´
- `UpdatedBy` - uniqueidentifier, æ›´æ–°äºº
- `UpdatedAt` - datetime2, æ›´æ–°æ—¶é—´
- `IsDeleted` - bit, æ˜¯å¦åˆ é™¤ (é»˜è®¤å€¼: false)

**ç´¢å¼•**:
- `IX_PaymentAutoDetail_PaymentAutoItemId` - å¤–é”®ç´¢å¼•
- `IX_PaymentAutoDetail_DebtDetailId` - æ™®é€šç´¢å¼•
- `IX_PaymentAutoDetail_IsDeleted` - æ™®é€šç´¢å¼•

### 3. PaymentAutoAgent (æ‰¹é‡ä»˜æ¬¾ä¾›åº”å•†è¡¨)
**ä¸»é”®**: Id (uniqueidentifier)
**å¤–é”®**: PaymentAutoItemId â†’ PaymentAutoItem.Id (çº§è”åˆ é™¤)

**å­—æ®µåˆ—è¡¨**:
- `Id` - Guid, ä¸»é”®
- `PaymentAutoItemId` - uniqueidentifier, æ‰¹é‡ä»˜æ¬¾å•ID
- `AgentId` - uniqueidentifier, ä¾›åº”å•†ID
- `AgentName` - nvarchar(200), ä¾›åº”å•†åç§°
- `AccountName` - nvarchar(200), è´¦æˆ·åç§°
- `AccountNo` - nvarchar(100), è´¦å·
- `BankName` - nvarchar(200), é“¶è¡Œåç§°
- `BankCode` - nvarchar(50), é“¶è¡Œä»£ç 
- `PaymentType` - nvarchar(200), ä»˜æ¬¾ç±»å‹
- `TransferRemark` - nvarchar(500), è½¬è´¦å¤‡æ³¨
- `InvoiceNo` - nvarchar(200), å‘ç¥¨å·
- `ContractNo` - nvarchar(200), åˆåŒå·
- `IsCrossBorderPayment` - int, æ˜¯å¦è·¨å¢ƒæ”¯ä»˜
- `TransactionCode` - nvarchar(100), äº¤æ˜“ä»£ç 
- `TransactionRemark` - nvarchar(500), äº¤æ˜“å¤‡æ³¨
- `IsBondedGoods` - int, æ˜¯å¦ä¿ç¨è´§ç‰©
- `FeeBearer` - nvarchar(10), è´¹ç”¨æ‰¿æ‹…æ–¹
- `CustomsGoods` - nvarchar(500), æµ·å…³è´§ç‰©
- `AttachmentIds` - nvarchar(2000), é™„ä»¶IDåˆ—è¡¨
- `IsDebtTransfer` - bit, æ˜¯å¦å€ºåŠ¡è½¬ç§»
- `DebtTransferAgentId` - uniqueidentifier, å€ºåŠ¡è½¬ç§»ä¾›åº”å•†ID
- `DebtTransferAgentName` - nvarchar(200), å€ºåŠ¡è½¬ç§»ä¾›åº”å•†åç§°
- `DebtTransferAccount` - nvarchar(200), å€ºåŠ¡è½¬ç§»è´¦æˆ·
- `DebtTransferBankAccount` - nvarchar(200), å€ºåŠ¡è½¬ç§»é“¶è¡Œè´¦æˆ·
- `DebtTransferBank` - nvarchar(200), å€ºåŠ¡è½¬ç§»é“¶è¡Œ
- `DebtTransferBankName` - nvarchar(200), å€ºåŠ¡è½¬ç§»é“¶è¡Œåç§°
- `DebtTransferBankCode` - nvarchar(200), å€ºåŠ¡è½¬ç§»é“¶è¡Œä»£ç 
- `DebtTransferAttachments` - nvarchar(2000), å€ºåŠ¡è½¬ç§»é™„ä»¶
- `GroupBusinessPaymentId` - int, é›†å›¢ä¸šåŠ¡ä»˜æ¬¾ID
- `CreatedBy` - uniqueidentifier, åˆ›å»ºäºº
- `CreatedAt` - datetime2, åˆ›å»ºæ—¶é—´
- `UpdatedBy` - uniqueidentifier, æ›´æ–°äºº
- `UpdatedAt` - datetime2, æ›´æ–°æ—¶é—´
- `IsDeleted` - bit, æ˜¯å¦åˆ é™¤ (é»˜è®¤å€¼: false)

**ç´¢å¼•**:
- `IX_PaymentAutoAgent_PaymentAutoItemId` - å¤–é”®ç´¢å¼•
- `IX_PaymentAutoAgent_AgentId` - æ™®é€šç´¢å¼•
- `IX_PaymentAutoAgent_IsDeleted` - æ™®é€šç´¢å¼•

## é…ç½®æ›´æ–°

### 1. Backend é¡¹ç›®é…ç½®
**æ–‡ä»¶**: `Inno.CorePlatform.Finance.Backend.csproj`
- âœ… æ·»åŠ äº† `Microsoft.EntityFrameworkCore.Design` åŒ…å¼•ç”¨

**æ–‡ä»¶**: `appsettings.json`
- âœ… æ›´æ–°è¿æ¥å­—ç¬¦ä¸²ä¸º LocalDB: `Server=(localdb)\\MSSQLLocalDB;Database=Finance;...`

### 2. Infrastructure é¡¹ç›®é…ç½®
**æ–‡ä»¶**: `ServiceCollectionExtensions.cs`
- âœ… æ³¨å†Œ `PaymentAutoItemRepository`
- âš ï¸ `IDebtDetailRepository` å’Œ `IAgentRepository` å¾…å®ç°
- âš ï¸ `PaymentAutoApplicationService` å¾…å®Œæ•´æ³¨å†Œ

## ä¸‹ä¸€æ­¥å·¥ä½œ

### å¿…é¡»å®Œæˆçš„ä»»åŠ¡

1. **å®ç°ç¼ºå¤±çš„ä»“å‚¨**
   ```csharp
   // éœ€è¦åˆ›å»ºä»¥ä¸‹ä»“å‚¨å®ç°ç±»:
   - DebtDetailRepository : IDebtDetailRepository
   - AgentRepository : IAgentRepository
   ```

2. **å–æ¶ˆæ³¨é‡Šåº”ç”¨æœåŠ¡æ³¨å†Œ**
   åœ¨ `ServiceCollectionExtensions.cs` ä¸­:
   ```csharp
   services.AddScoped<IDebtDetailRepository, DebtDetailRepository>();
   services.AddScoped<IAgentRepository, AgentRepository>();
   services.AddScoped<IPaymentAutoApplicationService, PaymentAutoApplicationService>();
   ```

3. **åˆ›å»ºåº”ä»˜æ˜ç»†å’Œä¾›åº”å•†è¡¨**
   - éœ€è¦æ ¹æ®ä¸šåŠ¡æ–‡æ¡£åˆ›å»º `DebtDetail` å’Œ `Agent` è¡¨çš„è¿ç§»
   - æˆ–è€…å¦‚æœè¿™äº›è¡¨å·²å­˜åœ¨ï¼Œéœ€è¦ç¡®ä¿å­—æ®µåŒ¹é…

### å¯é€‰ä»»åŠ¡

1. **æµ‹è¯•æ•°æ®åº“è¿æ¥**
   ```bash
   dotnet run --project .\Finance\src\Inno.CorePlatform.Finance.Backend
   ```

2. **éªŒè¯APIç«¯ç‚¹**
   - è®¿é—® Swagger UI: `https://localhost:61801/swagger`
   - æµ‹è¯•æ‰¹é‡ä»˜æ¬¾å•çš„CRUDæ“ä½œ

3. **è¿è¡Œå•å…ƒæµ‹è¯•**
   ```bash
   dotnet test .\Finance\tests\Inno.CorePlatform.Finance.Domain.Tests
   dotnet test .\Finance\tests\Inno.CorePlatform.Finance.Application.Tests
   ```

## æŠ€æœ¯ç»†èŠ‚

### è¿ç§»å‘½ä»¤
```bash
# åˆ›å»ºè¿ç§»
dotnet ef migrations add AddPaymentAutoTables \
  --project .\Finance\src\Inno.CorePlatform.Finance.Infrastructure \
  --startup-project .\Finance\src\Inno.CorePlatform.Finance.Backend

# åº”ç”¨è¿ç§»
dotnet ef database update \
  --project .\Finance\src\Inno.CorePlatform.Finance.Infrastructure \
  --startup-project .\Finance\src\Inno.CorePlatform.Finance.Backend
```

### å›æ»šè¿ç§»ï¼ˆå¦‚éœ€è¦ï¼‰
```bash
# å›æ»šåˆ°ä¸Šä¸€ä¸ªè¿ç§»
dotnet ef database update 0 \
  --project .\Finance\src\Inno.CorePlatform.Finance.Infrastructure \
  --startup-project .\Finance\src\Inno.CorePlatform.Finance.Backend

# åˆ é™¤è¿ç§»
dotnet ef migrations remove \
  --project .\Finance\src\Inno.CorePlatform.Finance.Infrastructure \
  --startup-project .\Finance\src\Inno.CorePlatform.Finance.Backend
```

## ä½¿ç”¨ Navicat è¿æ¥ LocalDB

### å½“å‰ LocalDB å®ä¾‹ä¿¡æ¯

æ ¹æ®å®é™…è¿è¡ŒçŠ¶æ€ï¼š
```
å®ä¾‹åç§°: MSSQLLocalDB
ç‰ˆæœ¬: 15.0.4382.1
çŠ¶æ€: Running âœ…
å‘½åç®¡é“: np:\\.\pipe\LOCALDB#70702087\tsql\query
æ•°æ®åº“: Finance
```

### Navicat è¿æ¥æ­¥éª¤ï¼ˆæ¨èæ–¹æ³•ï¼‰

#### æ­¥éª¤ 1ï¼šæ–°å»ºè¿æ¥
1. æ‰“å¼€ **Navicat for SQL Server**
2. ç‚¹å‡»å·¦ä¸Šè§’ **"è¿æ¥"** æŒ‰é’®
3. é€‰æ‹© **"SQL Server"**

#### æ­¥éª¤ 2ï¼šé…ç½®è¿æ¥å‚æ•°

| å­—æ®µ | å€¼ | è¯´æ˜ |
|------|-----|------|
| **è¿æ¥å** | `Finance LocalDB` | è‡ªå®šä¹‰åç§° |
| **ä¸»æœº** | `(localdb)\MSSQLLocalDB` | LocalDB å®ä¾‹å |
| **ç«¯å£** | ç•™ç©º | LocalDB ä½¿ç”¨å‘½åç®¡é“ï¼Œä¸éœ€è¦ç«¯å£ |
| **èº«ä»½éªŒè¯** | **Windows èº«ä»½éªŒè¯** | å¿…é¡»é€‰æ‹©æ­¤é¡¹ |
| **æ•°æ®åº“** | `Finance` | å¯é€‰ï¼Œè¿æ¥åå†é€‰æ‹© |

#### æ­¥éª¤ 3ï¼šæµ‹è¯•è¿æ¥
1. ç‚¹å‡» **"æµ‹è¯•è¿æ¥"** æŒ‰é’®
2. çœ‹åˆ° âœ… "è¿æ¥æˆåŠŸ" æç¤º
3. ç‚¹å‡» **"ç¡®å®š"** ä¿å­˜è¿æ¥

#### æ­¥éª¤ 4ï¼šæŸ¥çœ‹æ•°æ®åº“è¡¨
è¿æ¥æˆåŠŸåï¼Œå±•å¼€ **Finance** æ•°æ®åº“ï¼Œå¯ä»¥çœ‹åˆ°ï¼š
- âœ… `PaymentAutoItem` - æ‰¹é‡ä»˜æ¬¾å•è¡¨
- âœ… `PaymentAutoDetail` - æ‰¹é‡ä»˜æ¬¾æ˜ç»†è¡¨
- âœ… `PaymentAutoAgent` - æ‰¹é‡ä»˜æ¬¾ä¾›åº”å•†è¡¨
- âœ… `__EFMigrationsHistory` - EF Core è¿ç§»å†å²è¡¨

### å¸¸è§é—®é¢˜è§£å†³

#### é—®é¢˜ 1ï¼šæ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨
**è§£å†³æ–¹æ¡ˆ**ï¼š
```powershell
# æ£€æŸ¥ LocalDB çŠ¶æ€
sqllocaldb info MSSQLLocalDB

# å¦‚æœæœªè¿è¡Œï¼Œå¯åŠ¨å®ä¾‹
sqllocaldb start MSSQLLocalDB
```

#### é—®é¢˜ 2ï¼šç«¯å£å·å¯¼è‡´è¿æ¥å¤±è´¥
**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç¡®ä¿ "ç«¯å£" å­—æ®µä¸ºç©º
- LocalDB ä½¿ç”¨å‘½åç®¡é“ï¼Œä¸éœ€è¦ç«¯å£å·

#### é—®é¢˜ 3ï¼šæ‰¾ä¸åˆ°æ•°æ®åº“ "Finance"
**è§£å†³æ–¹æ¡ˆ**ï¼š
1. å…ˆä¸æŒ‡å®šæ•°æ®åº“ï¼Œåªè¿æ¥åˆ° LocalDB
2. è¿æ¥æˆåŠŸåæŸ¥çœ‹æ•°æ®åº“åˆ—è¡¨
3. å¦‚æœæ²¡æœ‰ Finance æ•°æ®åº“ï¼Œè¿è¡Œæ•°æ®åº“è¿ç§»

### å¤‡é€‰è¿æ¥æ–¹å¼

å¦‚æœæ ‡å‡†æ–¹æ³•æ— æ³•è¿æ¥ï¼Œå¯ä»¥ä½¿ç”¨å®Œæ•´å‘½åç®¡é“è·¯å¾„ï¼š

**ä¸»æœº**: `np:\\.\pipe\LOCALDB#70702087\tsql\query`

âš ï¸ **æ³¨æ„**ï¼šç®¡é“åç§°ä¸­çš„æ•°å­—åœ¨ LocalDB é‡å¯åä¼šå˜åŒ–ï¼Œéœ€è¦é‡æ–°è·å–ã€‚

### å…¶ä»–æ•°æ®åº“å·¥å…·è¿æ¥

**SQL Server Management Studio (SSMS)**:
- æœåŠ¡å™¨åç§°: `(localdb)\MSSQLLocalDB`

**Azure Data Studio**:
- æœåŠ¡å™¨: `(localdb)\MSSQLLocalDB`
- èº«ä»½éªŒè¯ç±»å‹: Windows èº«ä»½éªŒè¯

**å‘½ä»¤è¡ŒéªŒè¯**:
```powershell
sqlcmd -S "(localdb)\MSSQLLocalDB" -d Finance -Q "SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES"
```

### è¯¦ç»†è¿æ¥é…ç½®æ–‡æ¡£

æ›´å¤šè¯¦ç»†ä¿¡æ¯è¯·å‚è€ƒï¼š[LocalDBè¿æ¥é…ç½®.md](./LocalDBè¿æ¥é…ç½®.md)

---

## æ€»ç»“

âœ… **å·²å®Œæˆ**:
- LocalDB éªŒè¯å’Œé…ç½®
- æ•°æ®åº“è¿ç§»åˆ›å»ºå’Œåº”ç”¨
- ä¸‰ä¸ªæ ¸å¿ƒè¡¨çš„åˆ›å»ºï¼ˆPaymentAutoItem, PaymentAutoDetail, PaymentAutoAgentï¼‰
- æ‰€æœ‰ç´¢å¼•å’Œå¤–é”®çº¦æŸé…ç½®
- è¿æ¥å­—ç¬¦ä¸²é…ç½®
- EF Core Design åŒ…å®‰è£…
- Navicat è¿æ¥é…ç½®è¯´æ˜

âš ï¸ **å¾…å®Œæˆ**:
- å®ç° `IDebtDetailRepository` å’Œ `IAgentRepository`
- å®Œæ•´æ³¨å†Œæ‰€æœ‰åº”ç”¨æœåŠ¡
- åˆ›å»ºæˆ–éªŒè¯å…³è”è¡¨ï¼ˆDebtDetail, Agentï¼‰

ğŸ‰ **æ‰¹é‡ä»˜æ¬¾åŠŸèƒ½çš„æ•°æ®åº“å±‚å·²æˆåŠŸæ­å»ºï¼**
