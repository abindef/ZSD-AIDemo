# 批量付款单用户故事

## 一、功能概述

批量付款单是财务模块的核心功能，用于将多个应付明细合并为一个批量付款单进行统一付款处理。

## 二、用户故事

### 2.1 新增批量付款单

**作为** 财务人员  
**我希望** 能够创建批量付款单  
**以便于** 统一处理多个供应商的付款

**操作流程**：
1. 点击"新增"按钮，打开新增弹窗
2. 选择公司（必填，下拉，从后端接口返回）
3. 选择核算部门（必填，下拉，从后端接口返回）
4. 根据查询条件筛选应付明细：
   - 应付单号
   - 供应商
   - 业务单元
   - 客户
   - 项目名称
   - 币种
   - 采购合同号
5. 通过单据类型标签页切换不同类型的应付明细
6. 勾选需要付款的应付明细，输入本次付款金额
7. 点击"确定"保存

**系统处理**：
- 自动生成唯一单号（格式：PAY + 年月日 + 4位序号，如 PAY202512150001）
- 单据日期默认为当前日期
- 状态默认为"待提交"
- 自动计算总金额（所有明细付款金额之和）
- 根据应付明细关联的供应商，自动生成批量付款供应商记录

### 2.2 编辑批量付款单

**作为** 财务人员  
**我希望** 能够修改待提交/已驳回状态的批量付款单  
**以便于** 调整付款明细和金额

**前置条件**：
- 批量付款单状态为"待提交"或"已驳回"

**操作流程**：
1. 选中列表中的批量付款单，点击"编辑"按钮
2. 弹窗自动带入单头信息（公司、核算部门、备注）
3. 可修改核算部门、备注
4. 可重新选择应付明细和调整付款金额
5. 点击"确定"保存

**系统处理**：
- 清除原有明细和供应商记录
- 重新生成明细和供应商记录
- 重新计算总金额

### 2.3 删除批量付款单

**作为** 财务人员  
**我希望** 能够删除不需要的批量付款单  
**以便于** 清理错误或无效的数据

**前置条件**：
- 批量付款单状态为"待提交"

**操作流程**：
1. 选中列表中待提交状态的批量付款单
2. 点击"删除"按钮
3. 确认删除操作

**系统处理**：
- 软删除批量付款单及其明细和供应商记录

### 2.4 提交审批

**作为** 财务人员  
**我希望** 能够提交批量付款单进行审批  
**以便于** 启动付款审批流程

**前置条件**：
- 批量付款单状态为"待提交"或"已驳回"
- 至少包含一条付款明细

**操作流程**：
1. 选中列表中的批量付款单
2. 点击"提交"按钮

**系统处理**：
- 状态变更为"审批中"
- 触发OA审批流程（后续集成）

### 2.5 查看批量付款单

**作为** 财务人员  
**我希望** 能够查看批量付款单的详细信息  
**以便于** 了解付款情况

**操作流程**：
1. 在列表中选中一条批量付款单
2. 右侧自动显示供应商信息
3. 下方自动显示付款明细信息

## 三、数据模型

### 3.1 批量付款单表（PaymentAutoItem）

| 字段名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| Id | Guid | 是 | 主键 | 自动生成 |
| Code | string | 是 | 批量付款单号 | PAY202512150001 |
| BillDate | DateTime | 是 | 单据日期 | 2025-12-15 |
| CompanyId | Guid | 是 | 公司ID | - |
| CompanyName | string | 是 | 公司名称 | 总部公司 |
| CompanyCode | string | 否 | 公司编码 | C001 |
| DepartmentIdPath | string | 是 | 部门ID路径 | 01/0101 |
| DepartmentNamePath | string | 否 | 部门名称路径 | 总部/财务部 |
| DepartmentCurrentId | string | 否 | 当前部门ID | 0101 |
| Status | int | 是 | 状态枚举 | 0-待提交/1-审批中/2-已完成/11-已驳回 |
| TotalAmount | decimal | 是 | 总金额（自动计算） | 80000.00 |
| Remark | string | 否 | 备注 | 2025年1月批量付款 |
| AttachmentIds | string | 否 | 附件ID列表 | - |
| OARequestId | string | 否 | OA审批单ID | - |
| IsDeleted | bool | 是 | 是否删除（软删除） | false |
| CreatedAt | DateTime | 是 | 创建时间 | - |
| CreatedBy | string | 是 | 创建人 | - |
| UpdatedAt | DateTime | 否 | 更新时间 | - |
| UpdatedBy | string | 否 | 更新人 | - |

### 3.2 批量付款明细表（PaymentAutoDetail）

| 字段名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| Id | Guid | 是 | 主键 | 自动生成 |
| PaymentAutoItemId | Guid | 是 | 批量付款单ID（外键） | - |
| DebtDetailId | Guid | 是 | 应付明细ID（关联） | - |
| PaymentAmount | decimal | 是 | 本次付款金额 | 50000.00 |
| PaymentNo | string | 否 | 付款流水号（付款后回填） | - |
| PaymentTime | DateTime? | 否 | 付款时间（付款后回填） | - |
| IsDeleted | bool | 是 | 是否删除（软删除） | false |

### 3.3 批量付款供应商表（PaymentAutoAgent）

| 字段名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| Id | Guid | 是 | 主键 | 自动生成 |
| PaymentAutoItemId | Guid | 是 | 批量付款单ID（外键） | - |
| AgentId | Guid | 是 | 供应商ID（关联） | - |
| AgentName | string | 是 | 供应商名称（冗余） | 上海XX贸易有限公司 |
| AccountName | string | 否 | 银行账户名称 | 上海XX贸易有限公司 |
| AccountNo | string | 否 | 银行账号 | 6222020202020202 |
| BankName | string | 否 | 开户行名称 | 中国工商银行上海分行 |
| BankCode | string | 否 | 开户行编码 | ICBKSH01 |
| IsDeleted | bool | 是 | 是否删除（软删除） | false |

### 3.4 应付表（Debt）

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| Id | Guid | 是 | 主键 |
| Code | string | 是 | 应付单号 |
| CompanyId | Guid | 是 | 公司ID |
| CompanyName | string | 是 | 公司名称 |
| CompanyCode | string | 否 | 公司编码 |
| DepartmentIdPath | string | 是 | 核算部门ID路径 |
| DepartmentNamePath | string | 否 | 核算部门名称路径 |
| DepartmentCurrentId | string | 否 | 核算部门当前ID |
| AgentId | Guid | 是 | 供应商ID |
| AgentName | string | 是 | 供应商名称 |
| DocumentType | string | 是 | 应付单据类型 |
| BusinessUnit | string | 否 | 业务单元 |
| Customer | string | 否 | 客户 |
| Currency | string | 否 | 币种（默认CNY） |
| PurchaseContractNo | string | 否 | 采购合同号 |
| ProjectName | string | 否 | 项目名称 |
| IsDeleted | bool | 是 | 是否删除（软删除） |

### 3.5 应付明细表（DebtDetail）

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| Id | Guid | 是 | 主键 |
| DebtId | Guid | 是 | 应付ID（外键） |
| SequenceNo | int | 是 | 序号 |
| PaymentTermType | string | 是 | 账期类型 |
| ExpectedPaymentDate | DateTime | 是 | 预计付款日期 |
| PaymentAmount | decimal | 是 | 应付金额 |
| PaidAmount | decimal | 是 | 已付金额 |
| RemainingAmount | decimal | 是 | 剩余金额（计算字段） |
| IsDeleted | bool | 是 | 是否删除（软删除） |

### 3.6 供应商表（Agent）

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| Id | Guid | 是 | 供应商ID |
| Name | string | 是 | 供应商名称 |
| Code | string | 是 | 供应商编码 |
| BankAccountName | string | 否 | 银行账号名称 |
| BankAccountNo | string | 否 | 银行账号 |
| BankName | string | 否 | 开户行名称 |
| BankCode | string | 否 | 开户行编码 |
| IsDeleted | bool | 是 | 是否删除（软删除） |

## 四、业务规则

### 4.1 状态流转规则

```
                    ┌─────────────┐
                    │   待提交    │
                    │   (0)       │
                    └──────┬──────┘
                           │ 提交
                           ▼
                    ┌─────────────┐
          ┌─────────│   审批中    │─────────┐
          │ 驳回    │   (1)       │  通过   │
          ▼         └─────────────┘         ▼
   ┌─────────────┐                   ┌─────────────┐
   │   已驳回    │                   │   已完成    │
   │   (11)      │                   │   (2)       │
   └──────┬──────┘                   └─────────────┘
          │ 重新编辑后提交
          └──────────────────────────────────┘
```

**状态枚举定义**：
```csharp
public enum PaymentAutoStatus
{
    WaitSubmit = 0,   // 待提交
    Holding = 1,      // 审批中
    Finished = 2,     // 已完成
    Rejected = 11     // 已驳回
}
```

**状态说明**：
| 状态 | 值 | 可编辑 | 可删除 | 可提交 | 说明 |
|------|-----|--------|--------|--------|------|
| 待提交 | 0 | ✅ | ✅ | ✅ | 新创建的批量付款单 |
| 审批中 | 1 | ❌ | ❌ | ❌ | 已提交审批，等待审批结果 |
| 已完成 | 2 | ❌ | ❌ | ❌ | 审批通过并完成付款 |
| 已驳回 | 11 | ✅ | ❌ | ✅ | 审批被驳回，可重新编辑提交 |

### 4.2 金额计算规则

1. **批量付款单总金额** = Σ(明细付款金额)
2. **本次付款金额** ≤ 应付明细剩余金额
3. **剩余金额** = 应付金额 - 已付金额
4. **供应商汇总金额** = Σ(该供应商相关明细的付款金额)

### 4.3 数据验证规则

**创建时验证**：
- 公司ID必填
- 核算部门路径必填
- 至少包含一条付款明细
- 每条明细的付款金额必须 > 0
- 付款金额不能超过应付明细的剩余金额

**编辑时验证**：
- 状态必须为"待提交"或"已驳回"
- 其他同创建验证

**删除时验证**：
- 状态必须为"待提交"

**提交时验证**：
- 状态必须为"待提交"或"已驳回"
- 至少包含一条付款明细

## 五、API接口设计

### 5.1 批量付款单接口

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/paymentAuto/page` | 分页查询批量付款单 |
| GET | `/api/paymentAuto/statusCount` | 获取各状态数量统计 |
| GET | `/api/paymentAuto/{id}` | 获取批量付款单详情 |
| GET | `/api/paymentAuto/{id}/agents` | 获取供应商信息列表 |
| GET | `/api/paymentAuto/{id}/details` | 获取付款明细列表 |
| POST | `/api/paymentAuto` | 创建批量付款单 |
| PUT | `/api/paymentAuto/{id}` | 更新批量付款单 |
| DELETE | `/api/paymentAuto/{ids}` | 删除批量付款单（支持批量） |
| POST | `/api/paymentAuto/{id}/submit` | 提交审批 |

### 5.2 应付单接口

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/debt/details` | 查询应付明细列表（用于选择） |

### 5.3 请求/响应示例

**分页查询请求**：
```
GET /api/paymentAuto/page?status=0&page=1&limit=20&code=PAY2025
```

**分页查询响应**：
```json
{
  "code": 200,
  "data": {
    "list": [
      {
        "id": "guid",
        "code": "PAY202512150001",
        "billDate": "2025-12-15",
        "companyName": "总部公司",
        "departmentNamePath": "总部/财务部",
        "status": 0,
        "statusDescription": "待提交",
        "totalAmount": 80000.00,
        "createdAt": "2025-12-15T10:00:00",
        "createdBy": "admin"
      }
    ],
    "total": 100
  }
}
```

**创建请求**：
```json
{
  "companyId": "guid",
  "companyName": "总部公司",
  "companyCode": "C001",
  "departmentIdPath": "01/0101",
  "departmentNamePath": "总部/财务部",
  "departmentCurrentId": "0101",
  "remark": "2025年1月批量付款",
  "details": [
    {
      "debtDetailId": "guid",
      "paymentAmount": 50000.00
    }
  ]
}
```

## 六、UI交互说明

### 6.1 页面布局

```
┌─────────────────────────────────────────────────────────────┐
│ 状态标签页: [全部(100)] [待提交(50)] [审批中(30)] [已完成(15)] [已驳回(5)] │
├─────────────────────────────────┬───────────────────────────┤
│                                 │                           │
│     批量付款单列表 (50%)        │    供应商信息 (50%)       │
│                                 │                           │
├─────────────────────────────────┴───────────────────────────┤
│                                                             │
│                    付款明细列表 (50%高度)                    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.2 列表联动

- 选中批量付款单 → 右侧显示供应商信息
- 选中批量付款单 → 下方显示付款明细
- 未选中时显示空状态提示

### 6.3 新增/编辑弹窗

```
┌─────────────────────────────────────────────────────────────┐
│ 新增批量付款单                                         [X] │
├─────────────────────────────────────────────────────────────┤
│ 公司: [下拉选择]     核算部门: [下拉选择]    备注: [输入框] │
├─────────────────────────────────────────────────────────────┤
│ 查询条件:                                                   │
│ 应付单号: [    ] 供应商: [    ] 业务单元: [    ]           │
│ 客户: [    ] 项目名称: [    ] 币种: [    ] 合同号: [    ]  │
│                                        [查询] [重置]        │
├─────────────────────────────────────────────────────────────┤
│ 单据类型: [预付账期] [入库账期] [销售账期] [回款账期] ...   │
├─────────────────────────────────────────────────────────────┤
│ □ | 应付单号 | 供应商 | 账期类型 | 预计付款日 | 剩余金额 | 本次付款 │
│ ☑ | AP001   | 供应商A | 预付账期 | 2025-01-15 | 50000   | [50000] │
│ ☑ | AP002   | 供应商B | 入库账期 | 2025-01-20 | 30000   | [30000] │
├─────────────────────────────────────────────────────────────┤
│ 汇总: 明细数量: 2    供应商数量: 2    总金额: 80,000.00    │
├─────────────────────────────────────────────────────────────┤
│                                      [取消]     [确定]      │
└─────────────────────────────────────────────────────────────┘
```

### 6.4 格式化规则

**金额格式化**：
- 右对齐
- 千分位分隔
- 保留两位小数
- 示例：50,000.00

**日期格式化**：
- 格式：YYYY-MM-DD
- 示例：2025-12-15

## 七、测试数据要求

### 7.1 应付单据类型

系统需要初始化以下6种应付单据类型的测试数据：
1. 预付账期
2. 入库账期
3. 销售账期
4. 回款账期
5. 验收账期
6. 质保账期

### 7.2 数据量要求

- 每种单据类型初始化 5-20 条应付单（Debt）
- 每条应付单包含 1-3 条应付明细（DebtDetail）
- 初始化 2-3 个供应商（Agent）
- 供应商包含完整的银行账号信息

### 7.3 数据关联关系

```
Agent (供应商)
  │
  └──< Debt (应付单)
         │
         └──< DebtDetail (应付明细)
                    │
                    └──< PaymentAutoDetail (批量付款明细)
                              │
                              └──> PaymentAutoItem (批量付款单)
                                        │
                                        └──< PaymentAutoAgent (批量付款供应商)
                                                    │
                                                    └──> Agent (供应商)
```

## 八、开发注意事项

### 8.1 数据库配置

**开发环境使用内存数据库**：
```json
// appsettings.Development.json
{
  "UseInMemoryDatabase": true
}
```

生产环境设置为 `false` 并配置 SQL Server 连接字符串。

### 8.2 前端对话框触发

使用 `inno-mc-vue3` 的 CRUD 组件时，新增/编辑对话框必须通过 `hooks` 触发：

```typescript
// ❌ 错误方式 - 不会触发对话框
crudMethod: {
  add: () => { dialogVisible.value = true }
}

// ✅ 正确方式 - 使用 hooks
hooks: {
  [CRUD.HOOK.afterToAdd]: (_crud: any) => {
    dialogData.value = null
    dialogIsEdit.value = false
    dialogVisible.value = true
  },
  [CRUD.HOOK.afterToEdit]: (_crud: any) => {
    dialogData.value = _crud.form
    dialogIsEdit.value = true
    dialogVisible.value = true
  }
}
```

### 8.3 Result 类方法

Application 层的 `Result` 类使用以下方法：

```csharp
// 成功
Result.Ok()                    // 无返回值
Result.Ok<T>(value)            // 有返回值

// 失败
Result.Fail(message)           // 无返回值
Result.Fail<T>(message)        // 有返回值
```

### 8.4 公司和部门选择

新增/编辑对话框中：
- **公司**：必填，下拉选择，从后端接口返回
- **核算部门**：必填，下拉选择，从后端接口返回

选择公司和部门后，才能查询应付明细列表。
