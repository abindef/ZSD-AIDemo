# æ‰¹é‡ä»˜æ¬¾å‰ç«¯å®ç°è¯´æ˜

## å®ç°æ—¶é—´
2025å¹´12æœˆ15æ—¥ 15:40

## åŠŸèƒ½æ¦‚è¿°

å·²å®Œæˆæ‰¹é‡ä»˜æ¬¾åŠŸèƒ½çš„å‰ç«¯å®ç°ï¼ŒåŒ…æ‹¬åˆ—è¡¨æŸ¥è¯¢ã€æ–°å¢ã€ç¼–è¾‘ã€åˆ é™¤ã€æäº¤ç­‰å®Œæ•´åŠŸèƒ½ã€‚

## æ–‡ä»¶ç»“æ„

```
src/
â”œâ”€â”€ api/
â”‚   â””â”€â”€ paymentAuto.ts              # APIæœåŠ¡å±‚
â”œâ”€â”€ views/
â”‚   â””â”€â”€ paymentAuto/
â”‚       â”œâ”€â”€ index.vue               # åˆ—è¡¨é¡µé¢
â”‚       â””â”€â”€ components/
â”‚           â”œâ”€â”€ PaymentAutoForm.vue         # åˆ›å»º/ç¼–è¾‘è¡¨å•
â”‚           â”œâ”€â”€ PaymentAutoDetail.vue       # è¯¦æƒ…å¯¹è¯æ¡†
â”‚           â””â”€â”€ DebtDetailSelector.vue      # åº”ä»˜æ˜ç»†é€‰æ‹©å™¨
```

## API æœåŠ¡å±‚

### æ–‡ä»¶ï¼š`api/paymentAuto.ts`

**æ ¸å¿ƒæ¥å£**ï¼š

```typescript
// åˆ›å»ºæ‰¹é‡ä»˜æ¬¾å•
createPaymentAuto(data: CreatePaymentAutoRequest)

// æ›´æ–°æ‰¹é‡ä»˜æ¬¾å•
updatePaymentAuto(id: string, data: UpdatePaymentAutoRequest)

// åˆ é™¤æ‰¹é‡ä»˜æ¬¾å•
deletePaymentAuto(id: string)

// æäº¤æ‰¹é‡ä»˜æ¬¾å•
submitPaymentAuto(id: string)

// è·å–è¯¦æƒ…
getPaymentAutoDetail(id: string)

// æ ¹æ®å•å·è·å–è¯¦æƒ…
getPaymentAutoByCode(code: string)

// æ›´æ–°çŠ¶æ€
updatePaymentAutoStatus(id: string, status: number)

// è®¡ç®—æ€»é‡‘é¢
calculateTotalAmount(id: string)

// éªŒè¯æ•°æ®
validatePaymentData(id: string)
```

**æ•°æ®ç±»å‹**ï¼š

```typescript
// æ‰¹é‡ä»˜æ¬¾å•DTO
interface PaymentAutoDto {
  id: string;
  code: string;
  billDate: string;
  companyId: string;
  companyName: string;
  companyCode: string;
  departmentIdPath?: string;
  departmentNamePath?: string;
  departmentCurrentId?: string;
  status: number;
  statusDescription: string;
  totalAmount: number;
  remark?: string;
  details: PaymentAutoDetailDto[];
  agents: PaymentAutoAgentDto[];
}

// çŠ¶æ€æšä¸¾
enum PaymentAutoStatus {
  Pending = 0,      // å¾…æäº¤
  Approving = 1,    // å®¡æ‰¹ä¸­
  Completed = 2,    // å·²å®Œæˆ
  Rejected = 11     // å·²é©³å›
}
```

## é¡µé¢ç»„ä»¶

### 1. åˆ—è¡¨é¡µé¢ (`index.vue`)

**åŠŸèƒ½ç‰¹æ€§**ï¼š
- âœ… å¤šæ¡ä»¶æŸ¥è¯¢ï¼ˆå•å·ã€å…¬å¸ã€çŠ¶æ€ã€æ—¥æœŸèŒƒå›´ï¼‰
- âœ… åˆ†é¡µæ˜¾ç¤º
- âœ… çŠ¶æ€æ ‡ç­¾æ˜¾ç¤º
- âœ… å•è¡Œé€‰æ‹©
- âœ… å¢åŠ æŒ‰é’®
- âœ… åˆ é™¤æŒ‰é’®ï¼ˆä»…å¾…æäº¤çŠ¶æ€å¯ç”¨ï¼‰
- âœ… æäº¤æŒ‰é’®ï¼ˆä»…å¾…æäº¤çŠ¶æ€å¯ç”¨ï¼‰
- âœ… æŸ¥çœ‹ã€ç¼–è¾‘ã€åˆ é™¤æ“ä½œ

**æ ¸å¿ƒä»£ç **ï¼š

```vue
<template>
  <div class="payment-auto-container">
    <!-- æŸ¥è¯¢è¡¨å• -->
    <el-card class="search-card">
      <el-form :inline="true" :model="searchForm">
        <el-form-item label="å•å·">
          <el-input v-model="searchForm.code" />
        </el-form-item>
        <!-- æ›´å¤šæŸ¥è¯¢æ¡ä»¶ -->
      </el-form>
    </el-card>

    <!-- æ“ä½œæŒ‰é’® -->
    <el-card class="toolbar-card">
      <el-button type="primary" @click="handleCreate">å¢åŠ </el-button>
      <el-button type="danger" @click="handleDelete">åˆ é™¤</el-button>
      <el-button type="success" @click="handleSubmit">æäº¤</el-button>
    </el-card>

    <!-- æ•°æ®è¡¨æ ¼ -->
    <el-card class="table-card">
      <el-table :data="tableData" @current-change="handleCurrentChange">
        <!-- è¡¨æ ¼åˆ— -->
      </el-table>
      <el-pagination />
    </el-card>
  </div>
</template>
```

**å…³é”®åŠŸèƒ½å®ç°**ï¼š

```typescript
// åˆ é™¤
const handleDelete = async () => {
  await ElMessageBox.confirm('ç¡®å®šè¦åˆ é™¤è¯¥æ‰¹é‡ä»˜æ¬¾å•å—ï¼Ÿ');
  await deletePaymentAuto(selectedRow.value.id);
  ElMessage.success('åˆ é™¤æˆåŠŸ');
  loadData();
};

// æäº¤
const handleSubmit = async () => {
  await ElMessageBox.confirm('ç¡®å®šè¦æäº¤è¯¥æ‰¹é‡ä»˜æ¬¾å•å—ï¼Ÿ');
  await submitPaymentAuto(selectedRow.value.id);
  ElMessage.success('æäº¤æˆåŠŸ');
  loadData();
};
```

### 2. åˆ›å»º/ç¼–è¾‘è¡¨å• (`PaymentAutoForm.vue`)

**åŠŸèƒ½ç‰¹æ€§**ï¼š
- âœ… å…¬å¸å’Œéƒ¨é—¨ä¿¡æ¯å¡«å†™
- âœ… é€‰æ‹©åº”ä»˜æ˜ç»†
- âœ… ä»˜æ¬¾é‡‘é¢ç¼–è¾‘
- âœ… æ˜ç»†åˆ é™¤
- âœ… å®æ—¶æ±‡æ€»ï¼ˆæ˜ç»†æ•°é‡ã€ä¾›åº”å•†æ•°é‡ã€æ€»é‡‘é¢ï¼‰
- âœ… è¡¨å•éªŒè¯

**è¡¨å•ç»“æ„**ï¼š

```vue
<template>
  <el-dialog :title="isEdit ? 'ç¼–è¾‘' : 'æ–°å¢'">
    <el-form :model="form" :rules="rules">
      <!-- åŸºæœ¬ä¿¡æ¯ -->
      <el-form-item label="å…¬å¸" prop="companyName">
        <el-input v-model="form.companyName" />
      </el-form-item>

      <!-- ä»˜æ¬¾æ˜ç»† -->
      <el-button @click="handleSelectDebtDetails">
        é€‰æ‹©åº”ä»˜æ˜ç»†
      </el-button>
      <el-table :data="form.details">
        <el-table-column prop="paymentAmount" label="ä»˜æ¬¾é‡‘é¢">
          <template #default="{ row }">
            <el-input-number v-model="row.paymentAmount" />
          </template>
        </el-table-column>
      </el-table>

      <!-- æ±‡æ€»ä¿¡æ¯ -->
      <el-descriptions>
        <el-descriptions-item label="æ€»é‡‘é¢">
          {{ formatMoney(totalAmount) }}
        </el-descriptions-item>
      </el-descriptions>
    </el-form>
  </el-dialog>
</template>
```

**ä¿å­˜é€»è¾‘**ï¼š

```typescript
const handleSave = async () => {
  await formRef.value.validate();

  const requestData = {
    companyId: form.companyId,
    companyName: form.companyName,
    companyCode: form.companyCode,
    details: form.details.map(d => ({
      debtDetailId: d.debtDetailId,
      paymentAmount: d.paymentAmount
    }))
  };

  if (isEdit) {
    await updatePaymentAuto(formData.id, requestData);
  } else {
    await createPaymentAuto(requestData);
  }

  emit('success');
};
```

### 3. è¯¦æƒ…å¯¹è¯æ¡† (`PaymentAutoDetail.vue`)

**åŠŸèƒ½ç‰¹æ€§**ï¼š
- âœ… æ˜¾ç¤ºå•å¤´ä¿¡æ¯
- âœ… æ˜¾ç¤ºä»˜æ¬¾æ˜ç»†åˆ—è¡¨
- âœ… æ˜¾ç¤ºä¾›åº”å•†ä¿¡æ¯åˆ—è¡¨
- âœ… çŠ¶æ€æ ‡ç­¾æ˜¾ç¤º
- âœ… é‡‘é¢æ ¼å¼åŒ–

**å¸ƒå±€ç»“æ„**ï¼š

```vue
<template>
  <el-dialog title="æ‰¹é‡ä»˜æ¬¾å•è¯¦æƒ…">
    <!-- å•å¤´ä¿¡æ¯ -->
    <el-descriptions :column="2" border>
      <el-descriptions-item label="å•å·">
        {{ detail?.code }}
      </el-descriptions-item>
      <el-descriptions-item label="çŠ¶æ€">
        <el-tag :type="getStatusTagType(detail?.status)">
          {{ detail?.statusDescription }}
        </el-tag>
      </el-descriptions-item>
      <!-- æ›´å¤šå­—æ®µ -->
    </el-descriptions>

    <!-- ä»˜æ¬¾æ˜ç»† -->
    <el-divider>ä»˜æ¬¾æ˜ç»†</el-divider>
    <el-table :data="detail?.details" />

    <!-- ä¾›åº”å•†ä¿¡æ¯ -->
    <el-divider>ä¾›åº”å•†ä¿¡æ¯</el-divider>
    <el-table :data="detail?.agents" />
  </el-dialog>
</template>
```

### 4. åº”ä»˜æ˜ç»†é€‰æ‹©å™¨ (`DebtDetailSelector.vue`)

**åŠŸèƒ½ç‰¹æ€§**ï¼š
- âœ… å¤šæ¡ä»¶æŸ¥è¯¢
- âœ… å¤šé€‰åŠŸèƒ½
- âœ… åˆ†é¡µæ˜¾ç¤º
- âœ… æ˜¾ç¤ºå‰©ä½™é‡‘é¢
- âœ… å®æ—¶ç»Ÿè®¡å·²é€‰æ€»é‡‘é¢

**é€‰æ‹©å™¨ç»“æ„**ï¼š

```vue
<template>
  <el-dialog title="é€‰æ‹©åº”ä»˜æ˜ç»†">
    <!-- æŸ¥è¯¢è¡¨å• -->
    <el-form :inline="true" :model="searchForm">
      <el-form-item label="åº”ä»˜å•å·">
        <el-input v-model="searchForm.debtCode" />
      </el-form-item>
    </el-form>

    <!-- æ•°æ®è¡¨æ ¼ -->
    <el-table
      :data="tableData"
      @selection-change="handleSelectionChange"
    >
      <el-table-column type="selection" />
      <el-table-column prop="debtCode" label="åº”ä»˜å•å·" />
      <el-table-column prop="remainingAmount" label="å‰©ä½™é‡‘é¢" />
      <!-- æ›´å¤šåˆ— -->
    </el-table>

    <template #footer>
      <div>å·²é€‰æ‹© {{ selectedRows.length }} æ¡ï¼Œæ€»é‡‘é¢ï¼š{{ selectedTotalAmount }}</div>
      <el-button @click="handleConfirm">ç¡®å®š</el-button>
    </template>
  </el-dialog>
</template>
```

## çŠ¶æ€ç®¡ç†

### çŠ¶æ€æ˜¾ç¤º

```typescript
// çŠ¶æ€æ ‡ç­¾ç±»å‹æ˜ å°„
function getStatusTagType(status: number): string {
  switch (status) {
    case 0: return 'info';      // å¾…æäº¤ - ç°è‰²
    case 1: return 'warning';   // å®¡æ‰¹ä¸­ - æ©™è‰²
    case 2: return 'success';   // å·²å®Œæˆ - ç»¿è‰²
    case 11: return 'danger';   // å·²é©³å› - çº¢è‰²
    default: return 'info';
  }
}
```

### æŒ‰é’®æƒé™æ§åˆ¶

```vue
<!-- åˆ é™¤æŒ‰é’®ï¼šä»…å¾…æäº¤çŠ¶æ€å¯ç”¨ -->
<el-button
  type="danger"
  :disabled="!selectedRow || selectedRow.status !== 0"
  @click="handleDelete"
>
  åˆ é™¤
</el-button>

<!-- æäº¤æŒ‰é’®ï¼šä»…å¾…æäº¤çŠ¶æ€å¯ç”¨ -->
<el-button
  type="success"
  :disabled="!selectedRow || selectedRow.status !== 0"
  @click="handleSubmit"
>
  æäº¤
</el-button>
```

## å·¥å…·å‡½æ•°

### é‡‘é¢æ ¼å¼åŒ–

```typescript
const formatMoney = (value: number) => {
  return value?.toLocaleString('zh-CN', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  }) || '0.00';
};
```

### æ—¥æœŸæ ¼å¼åŒ–

```typescript
const formatDate = (date: string) => {
  return new Date(date).toLocaleString('zh-CN');
};
```

## ä½¿ç”¨æµç¨‹

### 1. åˆ›å»ºæ‰¹é‡ä»˜æ¬¾å•

```
1. ç‚¹å‡»"å¢åŠ "æŒ‰é’®
   â†“
2. å¡«å†™å…¬å¸å’Œéƒ¨é—¨ä¿¡æ¯
   â†“
3. ç‚¹å‡»"é€‰æ‹©åº”ä»˜æ˜ç»†"
   â†“
4. åœ¨é€‰æ‹©å™¨ä¸­å‹¾é€‰åº”ä»˜æ˜ç»†
   â†“
5. è°ƒæ•´ä»˜æ¬¾é‡‘é¢ï¼ˆå¯é€‰ï¼‰
   â†“
6. ç‚¹å‡»"ä¿å­˜"
   â†“
7. è°ƒç”¨ createPaymentAuto API
   â†“
8. åˆ›å»ºæˆåŠŸï¼Œåˆ·æ–°åˆ—è¡¨
```

### 2. æäº¤æ‰¹é‡ä»˜æ¬¾å•

```
1. åœ¨åˆ—è¡¨ä¸­é€‰æ‹©å¾…æäº¤çš„è®°å½•
   â†“
2. ç‚¹å‡»"æäº¤"æŒ‰é’®
   â†“
3. ç¡®è®¤æäº¤
   â†“
4. è°ƒç”¨ submitPaymentAuto API
   â†“
5. çŠ¶æ€å˜æ›´ä¸º"å®¡æ‰¹ä¸­"
   â†“
6. åˆ·æ–°åˆ—è¡¨
```

### 3. åˆ é™¤æ‰¹é‡ä»˜æ¬¾å•

```
1. åœ¨åˆ—è¡¨ä¸­é€‰æ‹©å¾…æäº¤çš„è®°å½•
   â†“
2. ç‚¹å‡»"åˆ é™¤"æŒ‰é’®
   â†“
3. ç¡®è®¤åˆ é™¤
   â†“
4. è°ƒç”¨ deletePaymentAuto API
   â†“
5. è½¯åˆ é™¤æˆåŠŸ
   â†“
6. åˆ·æ–°åˆ—è¡¨
```

## API è°ƒç”¨ç¤ºä¾‹

### åˆ›å»ºæ‰¹é‡ä»˜æ¬¾å•

```typescript
import { createPaymentAuto } from '@/api/paymentAuto';

const createPayment = async () => {
  const response = await createPaymentAuto({
    companyId: '11111111-1111-1111-1111-111111111111',
    companyName: 'æ€»éƒ¨å…¬å¸',
    companyCode: 'C001',
    departmentIdPath: '01/0101',
    departmentNamePath: 'æ€»éƒ¨/è´¢åŠ¡éƒ¨',
    departmentCurrentId: '0101',
    remark: '2025å¹´1æœˆæ‰¹é‡ä»˜æ¬¾',
    details: [
      {
        debtDetailId: 'detail-id-1',
        paymentAmount: 50000.00
      },
      {
        debtDetailId: 'detail-id-2',
        paymentAmount: 30000.00
      }
    ]
  });

  console.log('åˆ›å»ºæˆåŠŸ:', response.data);
};
```

### æäº¤æ‰¹é‡ä»˜æ¬¾å•

```typescript
import { submitPaymentAuto } from '@/api/paymentAuto';

const submitPayment = async (id: string) => {
  const response = await submitPaymentAuto(id);
  console.log('æäº¤æˆåŠŸ:', response.data);
};
```

### åˆ é™¤æ‰¹é‡ä»˜æ¬¾å•

```typescript
import { deletePaymentAuto } from '@/api/paymentAuto';

const deletePayment = async (id: string) => {
  const response = await deletePaymentAuto(id);
  console.log('åˆ é™¤æˆåŠŸ:', response.data);
};
```

## å¾…å®Œå–„åŠŸèƒ½

### éœ€è¦åç«¯æ”¯æŒçš„åŠŸèƒ½

1. **åˆ—è¡¨æŸ¥è¯¢API**
   - åˆ†é¡µæŸ¥è¯¢æ‰¹é‡ä»˜æ¬¾å•åˆ—è¡¨
   - æ”¯æŒå¤šæ¡ä»¶ç­›é€‰

2. **åº”ä»˜æ˜ç»†æŸ¥è¯¢API**
   - æŸ¥è¯¢å¯ç”¨çš„åº”ä»˜æ˜ç»†
   - æ”¯æŒæŒ‰ä¾›åº”å•†ã€å…¬å¸ç­›é€‰
   - åªè¿”å›æœªä»˜æ¬¾æˆ–éƒ¨åˆ†ä»˜æ¬¾çš„æ˜ç»†

### å‰ç«¯ä¼˜åŒ–å»ºè®®

1. **çŠ¶æ€ç®¡ç†**
   - ä½¿ç”¨ Pinia ç®¡ç†æ‰¹é‡ä»˜æ¬¾å•çŠ¶æ€
   - ç¼“å­˜æŸ¥è¯¢æ¡ä»¶

2. **æ€§èƒ½ä¼˜åŒ–**
   - è™šæ‹Ÿæ»šåŠ¨ï¼ˆå¤§æ•°æ®é‡æ—¶ï¼‰
   - é˜²æŠ–æœç´¢
   - æ‡’åŠ è½½æ˜ç»†æ•°æ®

3. **ç”¨æˆ·ä½“éªŒ**
   - æ·»åŠ åŠ è½½åŠ¨ç”»
   - ä¼˜åŒ–é”™è¯¯æç¤º
   - æ·»åŠ æ“ä½œç¡®è®¤

## æŠ€æœ¯æ ˆ

- **æ¡†æ¶**: Vue 3 + TypeScript
- **UIç»„ä»¶**: Element Plus
- **HTTPå®¢æˆ·ç«¯**: Axios (é€šè¿‡ HttpRequest å°è£…)
- **çŠ¶æ€ç®¡ç†**: Pinia (æ¨è)
- **è·¯ç”±**: Vue Router

## ç›¸å…³æ–‡æ¡£

- [æ‰¹é‡ä»˜æ¬¾åˆ é™¤å’Œæäº¤åŠŸèƒ½å®ç°](./æ‰¹é‡ä»˜æ¬¾åˆ é™¤å’Œæäº¤åŠŸèƒ½å®ç°.md)
- [æ‰¹é‡ä»˜æ¬¾å¢åŠ åŠŸèƒ½è¯´æ˜](./æ‰¹é‡ä»˜æ¬¾å¢åŠ åŠŸèƒ½è¯´æ˜.md)
- [æ‰¹é‡ä»˜æ¬¾å®ç°æ€»ç»“](./æ‰¹é‡ä»˜æ¬¾å®ç°æ€»ç»“.md)

## æ€»ç»“

âœ… **å·²å®Œæˆ**ï¼š
- API æœåŠ¡å±‚å®Œæ•´å®ç°
- åˆ—è¡¨é¡µé¢ï¼ˆæŸ¥è¯¢ã€åˆ†é¡µã€æ“ä½œï¼‰
- åˆ›å»º/ç¼–è¾‘è¡¨å•
- è¯¦æƒ…å¯¹è¯æ¡†
- åº”ä»˜æ˜ç»†é€‰æ‹©å™¨
- åˆ é™¤åŠŸèƒ½
- æäº¤åŠŸèƒ½
- çŠ¶æ€ç®¡ç†å’Œæƒé™æ§åˆ¶

â¸ï¸ **å¾…å®Œå–„**ï¼š
- åˆ—è¡¨æŸ¥è¯¢APIå¯¹æ¥
- åº”ä»˜æ˜ç»†æŸ¥è¯¢APIå¯¹æ¥
- çŠ¶æ€ç®¡ç†ä¼˜åŒ–
- æ€§èƒ½ä¼˜åŒ–

ğŸ‰ **æ‰¹é‡ä»˜æ¬¾å‰ç«¯åŠŸèƒ½å·²å®Œæ•´å®ç°ï¼Œå¯ä»¥è°ƒç”¨åç«¯APIè¿›è¡Œå¢åˆ æ”¹æŸ¥å’Œæäº¤æ“ä½œï¼**
