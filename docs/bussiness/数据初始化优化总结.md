# 数据初始化优化总结

## 优化时间
2025年12月15日 15:21

## 优化目标

根据业务需求，为每种应付单据类型初始化 5-20 条记录，提供更真实的测试数据。

## 应付单据类型

根据文档要求，应付单据类型包括：
1. **预付账期** - 预付款相关业务
2. **入库账期** - 采购入库业务
3. **销售账期** - 销售业务
4. **回款账期** - 回款管理业务
5. **验收账期** - 项目验收业务
6. **质保账期** - 质保金管理业务

## 数据生成策略

### 1. 应付单数量配置

| 单据类型 | 数量 | 业务单元 | 说明 |
|---------|------|---------|------|
| 预付账期 | 8 | 预付BU | 预付款业务 |
| 入库账期 | 12 | 采购BU | 采购入库最常见 |
| 销售账期 | 10 | 销售BU | 销售业务 |
| 回款账期 | 7 | 财务BU | 回款管理 |
| 验收账期 | 15 | 项目BU | 项目验收最多 |
| 质保账期 | 6 | 质保BU | 质保金管理 |
| **合计** | **58** | - | 6种类型 |

### 2. 数据生成规则

**应付单生成规则**：
- **单号格式**：`AP{日期yyyyMMdd}{序号4位}`，如 `AP202503020013`
- **日期范围**：2025-01-01 至 2025-12-16（随机分布）
- **公司分配**：随机选择总部公司或华东分公司
- **部门分配**：随机选择4个部门之一
- **供应商分配**：随机选择2个供应商之一
- **采购合同号**：入库账期和预付账期自动生成，格式 `PO-{年份}-{4位随机数}`
- **项目名称**：验收账期和质保账期自动生成，格式 `{单据类型}项目{序号}`

**应付明细生成规则**：
- **明细数量**：每个应付单生成 1-3 个明细（随机）
- **付款金额**：5,000 - 200,000 元（随机）
- **账期类型**：月结30天、月结60天、月结90天、即时付款、分期付款、预付款
- **预计付款日期**：根据账期类型自动计算
  - 即时付款：1-7 天
  - 月结30天：30-40 天
  - 月结60天：60-70 天
  - 月结90天：90-100 天
  - 预付款：提前 1-30 天
  - 分期付款：每期间隔 30 天

### 3. 数据分布

**公司分布**：
- 总部公司（C001）
- 华东分公司（C002）

**部门分布**：
- 总部/财务部（01/0101）
- 总部/项目部（01/0102）
- 华东/共享中心（02/0203）
- 华东/采购部（02/0204）

**供应商分布**：
- 上海XX贸易有限公司（S001）
- 杭州YY技术服务有限公司（S002）

## 实际生成结果

### 统计数据

**应付单统计**：
| 单据类型 | 应付单数量 | 明细数量 | 涉及供应商 | 日期范围 |
|---------|-----------|---------|-----------|---------|
| 入库账期 | 12 | 28 | 2 | 2025-03-02 ~ 2025-11-29 |
| 回款账期 | 7 | 17 | 2 | 2025-01-15 ~ 2025-10-22 |
| 质保账期 | 6 | 11 | 2 | 2025-02-08 ~ 2025-11-14 |
| 销售账期 | 10 | 21 | 2 | 2025-01-23 ~ 2025-12-05 |
| 预付账期 | 8 | 14 | 2 | 2025-02-19 ~ 2025-11-08 |
| 验收账期 | 15 | 28 | 2 | 2025-01-07 ~ 2025-12-12 |
| **合计** | **58** | **119** | **2** | **全年分布** |

**数据完整性**：
- ✅ 58 个应付单
- ✅ 119 个应付明细（平均每单 2.05 个明细）
- ✅ 6 种单据类型全覆盖
- ✅ 2 个供应商全部使用
- ✅ 日期分布全年（350天范围）

### 示例数据

**入库账期示例**：
```
AP202503020013 | 入库账期 | 华东分公司 | 杭州YY技术服务有限公司 | 采购BU | 2025-03-02
AP202505290018 | 入库账期 | 总部公司   | 上海XX贸易有限公司     | 采购BU | 2025-05-29
AP202506090010 | 入库账期 | 总部公司   | 杭州YY技术服务有限公司 | 采购BU | 2025-06-09
```

## 技术实现

### 代码优化

**文件**：`DataSeeder.cs`

**关键改进**：

1. **动态生成应付单**
```csharp
var documentTypes = new[]
{
    ("预付账期", "预付BU", 8),
    ("入库账期", "采购BU", 12),
    ("销售账期", "销售BU", 10),
    ("回款账期", "财务BU", 7),
    ("验收账期", "项目BU", 15),
    ("质保账期", "质保BU", 6)
};

foreach (var (docType, businessUnit, count) in documentTypes)
{
    for (int i = 1; i <= count; i++)
    {
        // 生成应付单数据
    }
}
```

2. **智能日期分配**
```csharp
var baseDate = new DateTime(2025, 1, 1);
var date = baseDate.AddDays(random.Next(0, 350)); // 全年随机分布
var code = $"AP{date:yyyyMMdd}{totalCount:D4}";
```

3. **条件字段生成**
```csharp
var contractNo = docType == "入库账期" || docType == "预付账期" 
    ? $"'PO-{date:yyyy}-{random.Next(1000, 9999)}'" 
    : "NULL";

var projectName = docType == "验收账期" || docType == "质保账期"
    ? $"N'{docType}项目{i}'"
    : "NULL";
```

4. **动态明细生成**
```csharp
foreach (var debt in debts)
{
    var detailCount = random.Next(1, 4); // 1-3个明细
    var baseAmount = random.Next(5000, 200000);
    
    for (int i = 1; i <= detailCount; i++)
    {
        // 根据账期类型计算预计付款日期
        var daysToAdd = paymentTermType switch
        {
            "即时付款" => random.Next(1, 7),
            "月结30天" => random.Next(30, 40),
            // ...
        };
    }
}
```

### 使用原始 SQL

由于 EF Core 值对象映射问题，应付单数据使用原始 SQL 插入：

```csharp
var sqlBuilder = new System.Text.StringBuilder();
sqlBuilder.AppendLine(@"INSERT INTO Debt (...) VALUES");
sqlBuilder.AppendLine(string.Join(",\n", values));
await context.Database.ExecuteSqlRawAsync(sqlBuilder.ToString());
```

**优点**：
- 绕过 EF Core 映射问题
- 批量插入性能更好
- 完全控制 SQL 语句

## 验证结果

### 数据库验证

```sql
-- 按单据类型统计
SELECT DocumentType, COUNT(*) as Count 
FROM Debt 
WHERE IsDeleted = 0 
GROUP BY DocumentType;

-- 结果：
入库账期: 12 条
回款账期: 7 条
质保账期: 6 条
销售账期: 10 条
预付账期: 8 条
验收账期: 15 条
```

### 应用启动日志

```
[15:20:58 INF] 已添加 2 个供应商
[15:20:58 INF] 已添加 58 个应付单，包含 6 种单据类型
[15:20:58 INF] 已添加 119 个应付明细，对应 58 个应付单
[15:20:58 INF] 数据初始化完成
[15:20:58 INF] Application started successfully
```

## 业务价值

### 1. 真实测试场景

- **多样化数据**：6种单据类型覆盖不同业务场景
- **时间分布**：全年日期分布，模拟真实业务节奏
- **数量充足**：58个应付单足够测试各种查询和统计功能

### 2. 批量付款测试

现在可以测试：
- **按单据类型筛选**：测试不同类型的批量付款
- **按日期范围筛选**：测试账期管理
- **按供应商筛选**：测试供应商维度的批量付款
- **按公司/部门筛选**：测试组织维度的批量付款

### 3. 性能测试

- **列表查询**：测试大数据量下的分页和排序
- **统计报表**：测试按维度汇总的性能
- **批量操作**：测试批量创建批量付款单的性能

## 数据查询示例

### 按单据类型查询

```sql
-- 查询入库账期的应付单
SELECT Code, CompanyName, AgentName, CreatedAt
FROM Debt
WHERE DocumentType = '入库账期' AND IsDeleted = 0
ORDER BY CreatedAt DESC;
```

### 按日期范围查询

```sql
-- 查询2025年上半年的应付单
SELECT DocumentType, COUNT(*) as Count, SUM(dd.PaymentAmount) as TotalAmount
FROM Debt d
LEFT JOIN DebtDetail dd ON d.Id = dd.DebtId
WHERE d.CreatedAt >= '2025-01-01' AND d.CreatedAt < '2025-07-01'
  AND d.IsDeleted = 0
GROUP BY DocumentType;
```

### 按供应商统计

```sql
-- 按供应商统计应付金额
SELECT AgentName, COUNT(DISTINCT d.Id) as DebtCount, 
       COUNT(dd.Id) as DetailCount,
       SUM(dd.PaymentAmount) as TotalAmount
FROM Debt d
LEFT JOIN DebtDetail dd ON d.Id = dd.DebtId
WHERE d.IsDeleted = 0
GROUP BY AgentName;
```

## 后续优化建议

### 1. 增加供应商数量

当前只有2个供应商，建议增加到 10-20 个供应商，使数据分布更真实。

### 2. 增加公司和部门

当前只有2个公司、4个部门，可以扩展到更多组织结构。

### 3. 添加更多业务字段

- 客户信息（销售账期）
- 项目详情（验收账期、质保账期）
- 合同金额（入库账期、预付账期）

### 4. 状态流转数据

添加部分已完成、已驳回状态的应付单，模拟完整的业务流程。

## 相关文档

- [供应商和应付表实现总结](./供应商和应付表实现总结.md)
- [数据库迁移完成报告](./数据库迁移完成报告.md)
- [批量付款数据库设计](./11.批量付款数据库设计.md)
- [问题解决-CompanyId-NULL错误](./问题解决-CompanyId-NULL错误.md)

## 总结

✅ **优化完成**：
- 生成 58 个应付单，覆盖 6 种单据类型
- 生成 119 个应付明细，平均每单 2.05 个明细
- 数据分布全年，模拟真实业务场景
- 每种单据类型 6-15 条记录，满足测试需求

✅ **数据质量**：
- 单号格式规范，包含日期信息
- 账期类型多样化，覆盖各种付款场景
- 预计付款日期根据账期类型智能计算
- 采购合同号和项目名称根据单据类型自动生成

🎉 **批量付款功能现在拥有充足的测试数据！**
